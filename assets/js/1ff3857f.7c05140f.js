"use strict";(self.webpackChunkkuberocketci_docs=self.webpackChunkkuberocketci_docs||[]).push([[65673],{8258:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"operator-guide/infrastructure-providers/okd/ssl-automation-okd","title":"Use Cert-Manager in OpenShift","description":"Automate Let\'s Encrypt certificate issuance and renewal in OpenShift using cert-manager with AWS Route53 for secured DNS name and wildcard certificates.","source":"@site/versioned_docs/version-3.9/operator-guide/infrastructure-providers/okd/ssl-automation-okd.md","sourceDirName":"operator-guide/infrastructure-providers/okd","slug":"/operator-guide/infrastructure-providers/okd/ssl-automation-okd","permalink":"/docs/3.9/operator-guide/infrastructure-providers/okd/ssl-automation-okd","draft":false,"unlisted":false,"editUrl":"https://github.com/KubeRocketCI/docs/edit/main/docs/operator-guide/infrastructure-providers/okd/ssl-automation-okd.md","tags":[],"version":"3.9","lastUpdatedBy":"Sergiy Kulanov","lastUpdatedAt":1740926376000,"frontMatter":{"title":"Use Cert-Manager in OpenShift","description":"Automate Let\'s Encrypt certificate issuance and renewal in OpenShift using cert-manager with AWS Route53 for secured DNS name and wildcard certificates.","sidebar_label":"Use Cert-Manager in OpenShift"},"sidebar":"operatorGuideSidebar","previous":{"title":"Deploy OKD 4.10 Cluster","permalink":"/docs/3.9/operator-guide/infrastructure-providers/okd/deploy-okd-4.10"},"next":{"title":"Install Velero","permalink":"/docs/3.9/operator-guide/disaster-recovery/install-velero"}}');var t=r(74848),i=r(28453);const a={title:"Use Cert-Manager in OpenShift",description:"Automate Let's Encrypt certificate issuance and renewal in OpenShift using cert-manager with AWS Route53 for secured DNS name and wildcard certificates.",sidebar_label:"Use Cert-Manager in OpenShift"},c="Use Cert-Manager in OpenShift",o={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Install Cert-Manager Operator",id:"install-cert-manager-operator",level:3},{value:"Create AWS Role for Route53",id:"create-aws-role-for-route53",level:3},{value:"Configure Cert-Manager Integration With AWS Route53",id:"configure-cert-manager-integration-with-aws-route53",level:3},{value:"Configure ClusterIssuers",id:"configure-clusterissuers",level:3},{value:"Configure Certificates",id:"configure-certificates",level:3},{value:"Modify OpenShift Router and API Server Custom Resources",id:"modify-openshift-router-and-api-server-custom-resources",level:3},{value:"Move From Let&#39;s Encrypt Staging Environment to Prod",id:"move-from-lets-encrypt-staging-environment-to-prod",level:3},{value:"Troubleshoot Certificates",id:"troubleshoot-certificates",level:3},{value:"Remove Obsolete Certificate Authority Data From Kubeconfig",id:"remove-obsolete-certificate-authority-data-from-kubeconfig",level:3},{value:"Certificate Renewals",id:"certificate-renewals",level:3},{value:"Related Articles",id:"related-articles",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components},{Details:s,Head:a}=n;return s||p("Details",!0),a||p("Head",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"use-cert-manager-in-openshift",children:"Use Cert-Manager in OpenShift"})}),"\n",(0,t.jsx)(a,{children:(0,t.jsx)("link",{rel:"canonical",href:"https://docs.kuberocketci.io/docs/operator-guide/infrastructure-providers/okd/ssl-automation-okd"})}),"\n",(0,t.jsxs)(n.p,{children:["The following material covers ",(0,t.jsx)(n.a,{href:"https://letsencrypt.org/",children:"Let's Encrypt"})," certificate automation with ",(0,t.jsx)(n.a,{href:"https://github.com/cert-manager/cert-manager",children:"cert-manager"})," using ",(0,t.jsx)(n.a,{href:"https://aws.amazon.com/route53/",children:"AWS Route53"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/",children:"cert-manager"})," is a Kubernetes/OpenShift operator that allows to issue and automatically renew SSL certificates. In this tutorial, the steps to secure DNS Name will be demonstrated."]}),"\n",(0,t.jsxs)(n.p,{children:["Below is an instruction on how to automatically issue and install wildcard certificates on OpenShift Ingress Controller and API Server covering all cluster Routes. To secure separate OpenShift Routes, please refer to the ",(0,t.jsx)(n.a,{href:"https://github.com/cert-manager/openshift-routes",children:"OpenShift Route Support"})," project for ",(0,t.jsx)(n.code,{children:"cert-manager"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"The cert-manager;"}),"\n",(0,t.jsx)(n.li,{children:"OpenShift v4.7 - v4.11;"}),"\n",(0,t.jsx)(n.li,{children:"Connection to the OpenShift Cluster;"}),"\n",(0,t.jsx)(n.li,{children:"Enabled AWS IRSA;"}),"\n",(0,t.jsxs)(n.li,{children:["The latest ",(0,t.jsxs)(n.a,{href:"https://github.com/openshift/okd/releases",children:[(0,t.jsx)(n.code,{children:"oc"})," utility"]}),". The ",(0,t.jsx)(n.code,{children:"kubectl"})," tool can also be used for most of the commands."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"install-cert-manager-operator",children:"Install Cert-Manager Operator"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"https://docs.openshift.com/container-platform/4.11/security/cert_manager_operator/cert-manager-operator-install.html",children:"Install"})," the ",(0,t.jsx)(n.code,{children:"cert-manager"})," operator via OpenShift ",(0,t.jsx)(n.a,{href:"https://docs.openshift.com/container-platform/4.11/operators/understanding/olm-understanding-operatorhub.html",children:"OperatorHub"})," that uses ",(0,t.jsx)(n.a,{href:"https://docs.openshift.com/container-platform/4.11/operators/understanding/olm/olm-understanding-olm.html",children:"Operator Lifecycle Manager (OLM)"}),":"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Go to the ",(0,t.jsx)(n.strong,{children:"OpenShift Admin Console"})," \u2192 ",(0,t.jsx)(n.strong,{children:"OperatorHub"}),", search for the ",(0,t.jsx)(n.code,{children:"cert-manager"}),", and click ",(0,t.jsx)(n.strong,{children:"Install"}),":"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Cert-Manager Installation",src:r(37092).A+"",title:"Cert-Manager Installation",width:"1331",height:"871"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Modify the ",(0,t.jsx)(n.code,{children:"ClusterServiceVersion"})," OLM resource, by selecting the ",(0,t.jsx)(n.strong,{children:"Update approval"})," \u2192 ",(0,t.jsx)(n.strong,{children:"Manual"}),". If selecting ",(0,t.jsx)(n.strong,{children:"Update approval"})," \u2192 ",(0,t.jsx)(n.strong,{children:"Automatic"})," after the automatic operator update, the parameters in the ",(0,t.jsx)(n.code,{children:"ClusterServiceVersion"})," will be reset to default."]}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.p,{children:["Installing an operator with ",(0,t.jsx)(n.strong,{children:"Manual approval"})," causes all operators installed in namespace ",(0,t.jsx)(n.code,{children:"openshift-operators"})," to function as ",(0,t.jsx)(n.a,{href:"https://docs.openshift.com/container-platform/4.11/operators/user/olm-installing-operators-in-namespace.html",children:"manual approval strategy"}),". In case the ",(0,t.jsx)(n.strong,{children:"Manual approval"})," is chosen, review the manual installation plan and approve it."]})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Cert-Manager Installation",src:r(73951).A+"",title:"Cert-Manager Installation",width:"1920",height:"908"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Navigate to ",(0,t.jsx)(n.strong,{children:"Operators"})," \u2192 ",(0,t.jsx)(n.strong,{children:"Installed Operators"})," and check the operator status to be ",(0,t.jsx)(n.strong,{children:"Succeeded"}),":"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Cert-Manager Installation",src:r(60662).A+"",title:"Cert-Manager Installation",width:"1911",height:"712"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["In case of errors, ",(0,t.jsx)(n.a,{href:"https://docs.openshift.com/container-platform/4.11/operators/admin/olm-status.html",children:"troubleshoot"})," the Operator issues:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc describe operator cert-manager -n openshift-operators\noc describe sub cert-manager -n openshift-operators\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"create-aws-role-for-route53",children:"Create AWS Role for Route53"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"cert-manager"})," should be configured to validate Wildcard certificates using the ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/tutorials/acme/dns-validation/",children:"DNS-based"})," method."]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Check the DNS ",(0,t.jsx)(n.strong,{children:"Hosted zone ID"})," in AWS Route53 for your domain."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Hosted Zone ID",src:r(745).A+"",title:"Hosted Zone ID",width:"1717",height:"512"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Create ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/configuration/acme/dns01/route53/#set-up-an-iam-role",children:"Route53 Permissions policy"})," in AWS for ",(0,t.jsx)(n.code,{children:"cert-manager"})," to be able to create DNS TXT records for the certificate validation. In this example, ",(0,t.jsx)(n.code,{children:"cert-manager"})," permissions are given for a particular DNS zone only. Replace ",(0,t.jsx)(n.strong,{children:"Hosted zone ID"})," ",(0,t.jsx)(n.em,{children:"XXXXXXXX"})," in the ",(0,t.jsx)(n.em,{children:'"Resource": "arn:aws:route53:::hostedzone/XXXXXXXXXXXX"'}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Action": "route53:GetChange",\n      "Resource": "arn:aws:route53:::change/*"\n    },\n    {\n      "Effect": "Allow",\n      "Action": [\n        "route53:ChangeResourceRecordSets",\n        "route53:ListResourceRecordSets"\n      ],\n      "Resource": "arn:aws:route53:::hostedzone/XXXXXXXXXXXX"\n    }\n  ]\n}\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Create an AWS Role with ",(0,t.jsx)(n.strong,{children:"Custom trust policy"})," for the ",(0,t.jsx)(n.code,{children:"cert-manager"})," service account to use the ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/configuration/acme/dns01/route53/#eks-iam-role-for-service-accounts-irsa",children:"AWS IRSA"})," feature and then attach the created policy. Replace the following:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"${aws-account-id}"})," with the AWS account ID of the EKS cluster."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"${aws-region}"})," with the region where the EKS cluster is located."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"${eks-hash}"})," with the hash in the EKS API URL; this will be a random 32 character hex string, for example, 45DABD88EEE3A227AF0FA468BE4EF0B5."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"${namespace}"})," with the namespace where cert-manager is running."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"${service-account-name}"})," with the name of the ServiceAccount object created by cert-manager."]}),"\n",(0,t.jsxs)(n.li,{children:["By default, it is ",(0,t.jsxs)(n.em,{children:['"system:serviceaccount:openshift-operators',":cert-manager",'"']})," if ",(0,t.jsx)(n.code,{children:"cert-manager"})," is installed via OperatorHub."]}),"\n",(0,t.jsxs)(n.li,{children:["Attach the created ",(0,t.jsx)(n.strong,{children:"Permission policy"})," for Route53 to the Role."]}),"\n",(0,t.jsxs)(n.li,{children:["Optionally, add ",(0,t.jsx)(n.strong,{children:"Permissions boundary"})," to the Role."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Action": "sts:AssumeRoleWithWebIdentity",\n      "Principal": {\n        "Federated": "arn:aws:iam::* ${aws-account-id}:oidc-provider/oidc.eks.${aws-region}.amazonaws.com/id/${eks-hash}"\n      },\n      "Condition": {\n        "StringEquals": {\n          "oidc.eks.${aws-region}.amazonaws.com/id/${eks-hash}:sub": "system:serviceaccount:${namespace}:${service-account-name}"\n        }\n      }\n    }\n  ]\n}\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Copy the created ",(0,t.jsx)(n.strong,{children:"Role ARN"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"configure-cert-manager-integration-with-aws-route53",children:"Configure Cert-Manager Integration With AWS Route53"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/configuration/acme/dns01/route53/#service-annotation",children:"Annotate"})," the ",(0,t.jsx)(n.code,{children:"ServiceAccount"})," created by ",(0,t.jsx)(n.code,{children:"cert-manager"})," (required for ",(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html",children:"AWS IRSA"}),"), and restart the ",(0,t.jsx)(n.code,{children:"cert-manager"})," pod."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Replace the ",(0,t.jsx)(n.code,{children:"eks.amazonaws.com/role-arn"})," annotation value with your own Role ARN."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc edit sa cert-manager -n openshift-operators\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'hl_lines="5"',children:"apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  annotations:\n    eks.amazonaws.com/role-arn: arn:aws:iam::XXXXXXXXXXXX:role/cert-manager\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Modify the ",(0,t.jsx)(n.code,{children:"cert-manager"})," ",(0,t.jsx)(n.code,{children:"Deployment"})," with the correct file system permissions ",(0,t.jsx)(n.code,{children:"fsGroup: 1001"}),", so that the ",(0,t.jsx)(n.code,{children:"ServiceAccount"})," token can be read."]}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.p,{children:["In case the ",(0,t.jsx)(n.code,{children:"ServiceAccount"})," token cannot be read and the operator is installed using the OperatorHub, add ",(0,t.jsx)(n.code,{children:"fsGroup: 1001"})," via OpenShift ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/installation/operator-lifecycle-manager/#configuration-via-clusterserviceversion-csv",children:"ClusterServiceVersion"})," OLM resource. It should be a ",(0,t.jsx)(n.code,{children:"cert-manager"})," controller spec. These actions are not required for OpenShift v4.10."]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc get csv\noc edit csv cert-manager.${VERSION}\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"spec:\n  template:\n    spec:\n      securityContext:\n        fsGroup: 1001\n      serviceAccountName: cert-manager\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Cert-Manager System Permissions",src:r(22624).A+"",title:"Cert-Manager System Permissions",width:"1910",height:"883"})}),"\n",(0,t.jsxs)(n.admonition,{type:"info",children:[(0,t.jsx)(n.p,{children:"A mutating admission controller will automatically modify all pods running with the service account:"}),(0,t.jsxs)(s,{children:[(0,t.jsx)("summary",{children:(0,t.jsx)("b",{children:"cert-manager controller pod"})}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps/v1\nkind: Pod\n# ...\nspec:\n  # ...\n  serviceAccountName: cert-manager\n  serviceAccount: cert-manager\n  containers:\n  - name: ...\n    # ...\n    env:\n      - name: AWS_ROLE_ARN\n        value: >-\n          arn:aws:iam::XXXXXXXXXXX:role/cert-manager\n      - name: AWS_WEB_IDENTITY_TOKEN_FILE\n        value: /var/run/secrets/eks.amazonaws.com/serviceaccount/token\n    volumeMounts:\n      - name: aws-iam-token\n        readOnly: true\n        mountPath: /var/run/secrets/eks.amazonaws.com/serviceaccount\n  volumes:\n    - name: aws-iam-token\n      projected:\n        sources:\n          - serviceAccountToken:\n              audience: sts.amazonaws.com\n              expirationSeconds: 86400\n              path: token\n        defaultMode: 420\n"})})]})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["If you have separate public and private DNS zones for the same domain (split-horizon DNS), modify the ",(0,t.jsx)(n.code,{children:"cert-manager"})," ",(0,t.jsx)(n.code,{children:"Deployment"})," in order to validate DNS TXT records via ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/configuration/acme/dns01/#setting-nameservers-for-dns01-self-check",children:"public recursive nameservers"}),"."]}),"\n",(0,t.jsxs)(n.admonition,{type:"note",children:[(0,t.jsx)(n.p,{children:"Otherwise, you will be getting an error during a record validation:"}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Waiting for DNS-01 challenge propagation: NS ns-123.awsdns-00.net.:53 returned REFUSED for `_acme-challenge`.\n"})}),(0,t.jsxs)(n.p,{children:["To avoid the error, add ",(0,t.jsx)(n.code,{children:"--dns01-recursive-nameservers-only --dns01-recursive-nameservers=8.8.8.8:53,1.1.1.1:53"})," as ARGs to the ",(0,t.jsx)(n.code,{children:"cert-manager"})," controller ",(0,t.jsx)(n.code,{children:"Deployment"}),"."]})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc get csv\noc edit csv cert-manager.${VERSION}\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"  labels:\n    app: cert-manager\n    app.kubernetes.io/component: controller\n    app.kubernetes.io/instance: cert-manager\n    app.kubernetes.io/name: cert-manager\n    app.kubernetes.io/version: v1.9.1\nspec:\n  containers:\n    - args:\n        - '--v=2'\n        - '--cluster-resource-namespace=$(POD_NAMESPACE)'\n        - '--leader-election-namespace=kube-system'\n        - '--dns01-recursive-nameservers-only'\n        - '--dns01-recursive-nameservers=8.8.8.8:53,1.1.1.1:53'\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"Deployment"})," must be modified via OpenShift ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/installation/operator-lifecycle-manager/#configuration-via-clusterserviceversion-csv",children:"ClusterServiceVersion"})," OLM resource if the operator was installed using the OperatorHub.\nThe OpenShift ",(0,t.jsx)(n.code,{children:"ClusterServiceVersion"})," OLM resource includes several Deployments, and the ARGs must be modified only for the ",(0,t.jsx)(n.code,{children:"cert-manager"})," controller."]})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Save the resource. After that, OLM will try to reload the resource automatically and save it to the YAML file. If OLM resets the config file, double-check the entered values."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Cert-Manager Nameservers",src:r(955).A+"",title:"Cert-Manager Nameservers",width:"1919",height:"893"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"configure-clusterissuers",children:"Configure ClusterIssuers"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"ClusterIssuer"})," is available on the whole cluster."]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Create the ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/configuration/acme/",children:"ClusterIssuer"})," resource for Let's Encrypt Staging and Prod environments that signs a Certificate using ",(0,t.jsx)(n.code,{children:"cert-manager"}),"."]}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.p,{children:["Let's Encrypt has a ",(0,t.jsx)(n.a,{href:"https://letsencrypt.org/docs/rate-limits/",children:"limit"})," of duplicate certificates in the Prod environment. Therefore, a ",(0,t.jsx)(n.code,{children:"ClusterIssuer"})," has been created for ",(0,t.jsx)(n.a,{href:"https://letsencrypt.org/docs/staging-environment/",children:"Let's Encrypt Staging"})," environment. By default, Let's Encrypt Staging certificates will not be trusted in your browser. The certificate validation cannot be tested in the Let's Encrypt Staging environment."]})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Change ",(0,t.jsx)(n.code,{children:"user@example.com"})," with your contact email."]}),"\n",(0,t.jsxs)(n.li,{children:["Replace ",(0,t.jsx)(n.code,{children:"hostedZoneID"})," XXXXXXXXXXX with the DNS ",(0,t.jsx)(n.strong,{children:"Hosted zone ID"})," in AWS for your domain."]}),"\n",(0,t.jsxs)(n.li,{children:["Replace the region value ",(0,t.jsx)(n.code,{children:"${region}"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["The secret under ",(0,t.jsx)(n.code,{children:"privateKeySecretRef"})," will be created automatically by the ",(0,t.jsx)(n.code,{children:"cert-manager"})," operator."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-staging\nspec:\n  acme:\n    email: user@example.com\n    server: https://acme-staging-v02.api.letsencrypt.org/directory\n    privateKeySecretRef:\n      name: letsencrypt-staging-issuer-account-key\n    solvers:\n    - dns01:\n        route53:\n          region: ${region}\n          hostedZoneID: XXXXXXXXXXX\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-prod\nspec:\n  acme:\n    email: user@example.com\n    server: https://acme-v02.api.letsencrypt.org/directory\n    privateKeySecretRef:\n      name: letsencrypt-prod-issuer-account-key\n    solvers:\n    - dns01:\n        route53:\n          region: ${region}\n          hostedZoneID: XXXXXXXXXXX\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Cert-Manager ClusterIssuer",src:r(86130).A+"",title:"Cert-Manager ClusterIssuer",width:"1917",height:"887"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Check the ",(0,t.jsx)(n.code,{children:"ClusterIssuer"})," status:"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Cert-Manager ClusterIssuer",src:r(56981).A+"",title:"Cert-Manager ClusterIssuer",width:"1920",height:"737"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc describe clusterissuer letsencrypt-prod\noc describe clusterissuer letsencrypt-staging\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["If the ",(0,t.jsx)(n.code,{children:"ClusterIssuer"})," state is not ready, investigate ",(0,t.jsx)(n.code,{children:"cert-manager"})," controller pod logs:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc get pod -n openshift-operators | grep 'cert-manager'\noc logs -f cert-manager-${replica_set}-${random_string} -n openshift-operators\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"configure-certificates",children:"Configure Certificates"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["In two different namespaces, create a ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/usage/certificate/",children:"Certificate"})," resource for the OpenShift Router (Ingress controller for OpenShift) and for the OpenShift APIServer."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["OpenShift Router supports a single wildcard certificate for Ingress/Route resources in different namespaces (so called, ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/faq/sync-secrets/#serving-a-wildcard-to-ingress-resources-in-different-namespaces-default-ssl-certificate",children:"default SSL certificate"}),"). The Ingress controller expects the certificates in a ",(0,t.jsx)(n.code,{children:"Secret"})," to be created in the ",(0,t.jsx)(n.code,{children:"openshift-ingress"})," namespace; the API Server, in the ",(0,t.jsx)(n.code,{children:"openshift-config"})," namespace. The ",(0,t.jsx)(n.code,{children:"cert-manager"})," operator will automatically create these secrets from the ",(0,t.jsx)(n.code,{children:"Certificate"})," resource."]}),"\n",(0,t.jsxs)(n.li,{children:["Replace ",(0,t.jsx)(n.code,{children:"${DOMAIN}"})," with your domain name. It can be checked with ",(0,t.jsx)(n.code,{children:"oc whoami --show-server"}),". Put domain names in quotes."]}),"\n"]}),"\n",(0,t.jsxs)(s,{children:[(0,t.jsx)("summary",{children:(0,t.jsxs)("b",{children:["The certificate for OpenShift Router in the ",(0,t.jsx)(n.code,{children:"openshift-ingress"})," namespace"]})}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: router-certs\n  namespace: openshift-ingress\n  labels:\n    app: cert-manager\nspec:\n  secretName: router-certs\n  secretTemplate:\n    labels:\n      app: cert-manager\n  duration: 2160h # 90d\n  renewBefore: 360h # 15d\n  subject:\n    organizations:\n      - Org Name\n  commonName: '*.${DOMAIN}'\n  privateKey:\n    algorithm: RSA\n    encoding: PKCS1\n    size: 2048\n    rotationPolicy: Always\n  usages:\n    - server auth\n    - client auth\n  dnsNames:\n    - '*.${DOMAIN}'\n    - '*.apps.${DOMAIN}'\n  issuerRef:\n    name: letsencrypt-staging\n    kind: ClusterIssuer\n"})})]}),"\n",(0,t.jsxs)(s,{children:[(0,t.jsx)("summary",{children:(0,t.jsxs)("b",{children:["The certificate for OpenShift APIServer in the ",(0,t.jsx)(n.code,{children:"openshift-config"})," namespace"]})}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: api-certs\n  namespace: openshift-config\n  labels:\n    app: cert-manager\nspec:\n  secretName: api-certs\n  secretTemplate:\n    labels:\n      app: cert-manager\n  duration: 2160h # 90d\n  renewBefore: 360h # 15d\n  subject:\n    organizations:\n      - Org Name\n  commonName: '*.${DOMAIN}'\n  privateKey:\n    algorithm: RSA\n    encoding: PKCS1\n    size: 2048\n    rotationPolicy: Always\n  usages:\n    - server auth\n    - client auth\n  dnsNames:\n    - '*.${DOMAIN}'\n    - '*.apps.${DOMAIN}'\n  issuerRef:\n    name: letsencrypt-staging\n    kind: ClusterIssuer\n"})})]}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"cert-manager"})," supports ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/faq/#is-ecc-elliptic-curve-cryptography-supported",children:"ECDSA"})," key pairs in the ",(0,t.jsx)(n.code,{children:"Certificate"})," resource. To use it, change RSA ",(0,t.jsx)(n.code,{children:"privateKey"})," to ECDSA:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"privateKey:\n  algorithm: ECDSA\n  encoding: PKCS1\n  size: 256\n  rotationPolicy: Always\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"rotationPolicy: Always"})," is highly recommended since ",(0,t.jsx)(n.code,{children:"cert-manager"})," does not ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/usage/certificate/#the-rotationpolicy-setting",children:"rotate private keys"})," by default."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Full ",(0,t.jsx)(n.code,{children:"Certificate"})," spec is described in the ",(0,t.jsx)(n.code,{children:"cert-manager"})," ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/reference/api-docs/#cert-manager.io/v1.CertificateSpec",children:"API documentation"}),"."]}),"\n"]}),"\n"]})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check that the certificates in the namespaces are ready:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Cert-Manager Certificate Status",src:r(4716).A+"",title:"Cert-Manager Certificate Status",width:"1920",height:"637"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Cert-Manager Certificate Status",src:r(83106).A+"",title:"Cert-Manager Certificate Status",width:"1901",height:"666"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check the details of the certificates via CLI:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc describe certificate api-certs -n openshift-config\noc describe certificate router-certs -n openshift-ingress\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check the cert-manager controller pod logs if the Staging Certificate condition is not ready for more than 7 minutes:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc get pod -n openshift-operators | grep 'cert-manager'\noc logs -f cert-manager-${replica_set}-${random_string} -n openshift-operators\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["When the certificate is ready, its private key will be put into the OpenShift ",(0,t.jsx)(n.code,{children:"Secret"})," in the namespace indicated in the ",(0,t.jsx)(n.code,{children:"Certificate"})," resource:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc describe secret api-certs -n openshift-config\noc describe secret router-certs -n openshift-ingress\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"modify-openshift-router-and-api-server-custom-resources",children:"Modify OpenShift Router and API Server Custom Resources"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Update the Custom Resource of your Router (Ingress controller). Patch the ",(0,t.jsx)(n.code,{children:"defaultCertificate"})," object value with ",(0,t.jsx)(n.code,{children:'{ "name": "router-certs" }'}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'oc patch ingresscontroller default -n openshift-ingress-operator --type=merge --patch=\'{"spec": { "defaultCertificate": { "name": "router-certs" }}}\' --insecure-skip-tls-verify\n'})}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.p,{children:["After updating the ",(0,t.jsx)(n.code,{children:"IngressController"})," object, the OpenShift Ingress operator redeploys the router."]})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Update the Custom Resource for the OpenShift API Server:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Export the name of ",(0,t.jsx)(n.code,{children:"APIServer"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"export OKD_API=$(oc whoami --show-server --insecure-skip-tls-verify | cut -f 2 -d ':' | cut -f 3 -d '/' | sed 's/-api././')\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Patch the ",(0,t.jsx)(n.code,{children:"servingCertificate"})," object value with ",(0,t.jsx)(n.code,{children:'{ "name": "api-certs" }'}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'oc patch apiserver cluster --type merge --patch="{\\"spec\\": {\\"servingCerts\\": {\\"namedCertificates\\": [ { \\"names\\": [  \\"$OKD_API\\"  ], \\"servingCertificate\\": {\\"name\\": \\"api-certs\\" }}]}}}" --insecure-skip-tls-verify\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"move-from-lets-encrypt-staging-environment-to-prod",children:"Move From Let's Encrypt Staging Environment to Prod"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Test the Staging certificate on the OpenShift Admin Console. The ",(0,t.jsx)(n.code,{children:"--insecure"})," flag is used because Let's Encrypt Staging certificates are not trusted in browsers by default:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl -v --insecure https://console-openshift-console.apps.${DOMAIN}\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Change ",(0,t.jsx)(n.code,{children:"issuerRef"})," to ",(0,t.jsx)(n.code,{children:"letsencrypt-prod"})," in both ",(0,t.jsx)(n.code,{children:"Certificate"})," resources:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc edit certificate api-certs -n openshift-config\noc edit certificate router-certs -n openshift-ingress\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"issuerRef:\n  name: letsencrypt-prod\n  kind: ClusterIssuer\n"})}),"\n",(0,t.jsxs)(n.admonition,{type:"note",children:[(0,t.jsxs)(n.p,{children:["In case the certificate reissue is not triggered after that, try to force the certificate renewal with ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/usage/cmctl/",children:"cmctl"}),":"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cmctl renew router-certs -n openshift-ingress\ncmctl renew api-certs -n openshift-config\n"})}),(0,t.jsxs)(n.p,{children:["If this won't work, delete the ",(0,t.jsx)(n.code,{children:"api-certs"})," and ",(0,t.jsx)(n.code,{children:"router-certs"})," secrets. It should trigger the Prod certificates issuance:"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc delete secret router-certs -n openshift-ingress\noc delete secret api-certs -n openshift-config\n"})}),(0,t.jsx)(n.p,{children:"Please note that these actions will lead to logging your account out of the OpenShift Admin Console, since certificates will be deleted. Accept the certificate warning in the browser and log in again after that."})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check the status of the Prod certificates:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc describe certificate api-certs -n openshift-config\noc describe certificate router-certs -n openshift-ingress\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cmctl status certificate api-certs -n openshift-config\ncmctl status certificate router-certs -n openshift-ingress\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check the web console and make sure it has secure connection:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl -v https://console-openshift-console.apps.${DOMAIN}\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"troubleshoot-certificates",children:"Troubleshoot Certificates"}),"\n",(0,t.jsxs)(n.p,{children:["Below is an example of the DNS TXT ",(0,t.jsx)(n.code,{children:"challenge"})," record created by the ",(0,t.jsx)(n.code,{children:"cert-manager"})," operator:"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"DNS Validation",src:r(73611).A+"",title:"DNS Validation",width:"1716",height:"650"})}),"\n",(0,t.jsxs)(n.p,{children:["Use ",(0,t.jsx)(n.code,{children:"nslookup"})," or ",(0,t.jsx)(n.code,{children:"dig"})," tools to check if the DNS propagation for the TXT record is complete:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"nslookup -type=txt _acme-challenge.${DOMAIN}\ndig txt _acme-challenge.${DOMAIN}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Otherwise, use web tools like ",(0,t.jsx)(n.a,{href:"https://toolbox.googleapps.com/apps/dig/#TXT/",children:"Google Admin Toolbox"}),":"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"DNS Validation",src:r(59792).A+"",title:"DNS Validation",width:"1557",height:"692"})}),"\n",(0,t.jsx)(n.p,{children:"If the correct TXT value is shown (the value corresponds to the current TXT value in the DNS zone), it means that the DNS propagation is complete and Let's Encrypt is able to access the record in order to validate it and issue a trusted certificate."}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.p,{children:["If the DNS validation challenge self check fails, ",(0,t.jsx)(n.code,{children:"cert-manager"})," will retry the self check with a fixed 10-second retry interval. ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/concepts/acme-orders-challenges/#challenge-lifecycle",children:"Challenges"})," that do not ever complete the self check will continue retrying until the user intervenes by either retrying the ",(0,t.jsx)(n.code,{children:"Order"})," (by deleting the ",(0,t.jsx)(n.code,{children:"Order"})," resource) or amending the associated ",(0,t.jsx)(n.code,{children:"Certificate"})," resource to resolve any configuration errors."]})}),"\n",(0,t.jsxs)(n.p,{children:["As soon as the domain ownership has been verified, any ",(0,t.jsx)(n.code,{children:"cert-manager"})," affected validation TXT records in the AWS Route53 DNS zone will be cleaned up."]}),"\n",(0,t.jsx)(n.p,{children:"Please find below the issues that may occur and their troubleshooting:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["When certificates are not issued for a long time, or a ",(0,t.jsx)(n.code,{children:"cert-manager"})," resource is not in a Ready state, ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/faq/troubleshooting/",children:"describing"})," a resource may show the reason for the error."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Basically, the ",(0,t.jsx)(n.code,{children:"cert-manager"})," creates the following resources during a ",(0,t.jsx)(n.code,{children:"Certificate"})," issuance: ",(0,t.jsx)(n.code,{children:"CertificateRequest"}),", ",(0,t.jsx)(n.code,{children:"Order"}),", and ",(0,t.jsx)(n.code,{children:"Challenge"}),". ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/faq/acme/",children:"Investigate"})," each of them in case of errors."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Use the ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/usage/cmctl/",children:"cmctl"})," tool to show the state of a ",(0,t.jsx)(n.code,{children:"Certificate"})," and its associated resources."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Check the ",(0,t.jsx)(n.code,{children:"cert-manager"})," controller pod logs:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc get pod -n openshift-operators | grep 'cert-manager'\noc logs -f cert-manager-${replica_set}-${random_string} -n openshift-operators\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Certificate error debugging:\na. Decode certificate chain located in the secrets:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc get secret router-certs -n openshift-ingress -o 'go-template={{index .data \"tls.crt\"}}' | base64 -d | while openssl x509 -noout -text; do :; done 2>/dev/null\noc get secret api-certs -n openshift-config -o 'go-template={{index .data \"tls.crt\"}}' | base64 -d | while openssl x509 -noout -text; do :; done 2>/dev/null\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cmctl inspect secret router-certs -n openshift-ingress\ncmctl inspect secret api-certs -n openshift-config\n"})}),"\n",(0,t.jsx)(n.p,{children:"b. Check the SSL RSA private key consistency:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc get secret router-certs -n openshift-ingress -o 'go-template={{index .data \"tls.key\"}}' | base64 -d | openssl rsa -check -noout\noc get secret api-certs -n openshift-config -o 'go-template={{index .data \"tls.key\"}}' | base64 -d | openssl rsa -check -noout\n"})}),"\n",(0,t.jsx)(n.p,{children:"c. Match the SSL certificate public key against its RSA private key. Their modulus must be identical:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"diff <(oc get secret api-certs -n openshift-config -o 'go-template={{index .data \"tls.crt\"}}' | base64 -d | openssl x509 -noout -modulus | openssl md5) <(oc get secret api-certs -n openshift-config -o 'go-template={{index .data \"tls.key\"}}' | base64 -d | openssl rsa -noout -modulus | openssl md5)\ndiff <(oc get secret router-certs -n openshift-ingress -o 'go-template={{index .data \"tls.crt\"}}' | base64 -d | openssl x509 -noout -modulus | openssl md5) <(oc get secret router-certs -n openshift-ingress -o 'go-template={{index .data \"tls.key\"}}' | base64 -d | openssl rsa -noout -modulus | openssl md5)\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"remove-obsolete-certificate-authority-data-from-kubeconfig",children:"Remove Obsolete Certificate Authority Data From Kubeconfig"}),"\n",(0,t.jsx)(n.p,{children:"After updating the certificates, the access to the cluster via Lens or CLI will be denied because of the untrusted certificate errors:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ oc whoami\nUnable to connect to the server: x509: certificate signed by unknown authority\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Such behavior appears because the ",(0,t.jsx)(n.code,{children:"oc"})," tool references an old CA data in the kubeconfig file."]}),"\n",(0,t.jsxs)(n.admonition,{type:"note",children:[(0,t.jsx)(n.p,{children:"Examine the Certificate Authority data using the following command:"}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"oc config view --minify --raw -o jsonpath='{.clusters[].cluster.certificate-authority-data}' | base64 -d | openssl x509 -text\n"})}),(0,t.jsxs)(n.p,{children:["This certificate has the ",(0,t.jsx)(n.code,{children:"CA:TRUE"})," parameter, which means that this is a self-signed root CA certificate."]})]}),"\n",(0,t.jsx)(n.p,{children:"To fix the error, remove the old CA data from your OpenShift kubeconfig file:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'sed -i "/certificate-authority-data/d" $KUBECONFIG\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Since this field will be absent in the kubeconfig file, system root SSL certificate will be used to validate the cluster certificate trust chain. On Ubuntu, Let's Encrypt OpenShift cluster certificates will be validated against ",(0,t.jsx)(n.code,{children:"Internet Security Research Group"})," root in ",(0,t.jsx)(n.code,{children:"/etc/ssl/certs/ca-certificates.crt"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"certificate-renewals",children:"Certificate Renewals"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"cert-manager"})," automatically ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/usage/certificate/#renewal",children:"renews"})," the certificates based on the X.509 certificate's duration and the ",(0,t.jsx)(n.code,{children:"renewBefore"})," value.\nThe minimum value for the ",(0,t.jsx)(n.code,{children:"spec.duration"})," is 1 hour; for ",(0,t.jsx)(n.code,{children:"spec.renewBefore"}),", 5 minutes. It is also required that ",(0,t.jsx)(n.code,{children:"spec.duration"})," > ",(0,t.jsx)(n.code,{children:"spec.renewBefore"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["Use the ",(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/usage/cmctl/",children:"cmctl"})," tool to manually trigger a single instant certificate renewal:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cmctl renew router-certs -n openshift-ingress\ncmctl renew api-certs -n openshift-config\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Otherwise, manually renew all certificates in all namespaces with the ",(0,t.jsx)(n.code,{children:"app=cert-manager"})," label:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cmctl renew --all-namespaces -l app=cert-manager\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Run the ",(0,t.jsx)(n.code,{children:"cmctl renew --help"})," command to get more details."]}),"\n",(0,t.jsx)(n.h2,{id:"related-articles",children:"Related Articles"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://cert-manager.io/docs/",children:"Cert-Manager Official Documentation"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.openshift.com/container-platform/4.11/security/cert_manager_operator/cert-manager-operator-install.html",children:"Installing the Cert-Manager Operator for Red Hat OpenShift"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://crt.sh/",children:"Checking Issued Certificate Details"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}function p(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},37092:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/ssl-okd-config-01-3dbf05879759f371fec1239d9a07503f.png"},73951:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/ssl-okd-config-02-80205b399bf53ebd1ee850a6737b9911.png"},60662:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/ssl-okd-config-03-5c7417621da99318c8329f96d72b1f3a.png"},745:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/ssl-okd-config-04-caae169f14167c44d5efdc778342035b.png"},22624:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/ssl-okd-config-05-6d26ceca8a90ff920e35d35fa082a384.png"},955:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/ssl-okd-config-06-3b66fec3bf9e16a5275ed59363efdd25.png"},86130:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/ssl-okd-config-07-321445eaaf7a90112d2c2e2a6031dce6.png"},56981:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/ssl-okd-config-08-ee91ee241767403e3b86f884a78491af.png"},4716:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/ssl-okd-config-09-9381a0b3a769eda01724bf2e23a81b0b.png"},83106:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/ssl-okd-config-10-5d3957ce02735c7764264dae785b9870.png"},73611:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/ssl-okd-config-11-19a716e5ccab69f8feafee82741d5781.png"},59792:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/ssl-okd-config-12-5f46be7fc743de982628a75032d544e9.png"},28453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>c});var s=r(96540);const t={},i=s.createContext(t);function a(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);