"use strict";(self.webpackChunkkuberocketci_docs=self.webpackChunkkuberocketci_docs||[]).push([[46657],{40373:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>i,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"id":"operator-guide/upgrade/upgrade-keycloak-19.0","title":"Upgrade Keycloak v17.0 to 19.0","description":"Guide on upgrading Keycloak from version 17.0.x-legacy to 19.0.x on Kubernetes, detailing prerequisites, database migration strategies, and Keycloak configuration adjustments.","source":"@site/versioned_docs/version-3.9/operator-guide/upgrade/upgrade-keycloak-19.0.md","sourceDirName":"operator-guide/upgrade","slug":"/operator-guide/upgrade/upgrade-keycloak-19.0","permalink":"/docs/3.9/operator-guide/upgrade/upgrade-keycloak-19.0","draft":false,"unlisted":false,"editUrl":"https://github.com/KubeRocketCI/docs/edit/main/docs/operator-guide/upgrade/upgrade-keycloak-19.0.md","tags":[],"version":"3.9","lastUpdatedBy":"Oleksandr_Stepanov@epam.com","lastUpdatedAt":1740746844000,"frontMatter":{"title":"Upgrade Keycloak v17.0 to 19.0","description":"Guide on upgrading Keycloak from version 17.0.x-legacy to 19.0.x on Kubernetes, detailing prerequisites, database migration strategies, and Keycloak configuration adjustments.","sidebar_label":"Upgrade Keycloak to 19.0"},"sidebar":"operatorGuideSidebar","previous":{"title":"Upgrade EDP to 3.0","permalink":"/docs/3.9/operator-guide/upgrade/upgrade-edp-3.0"},"next":{"title":"Migrate Jenkins to Tekton","permalink":"/docs/3.9/operator-guide/upgrade/migrate-ci-pipelines-from-jenkins-to-tekton"}}');var t=n(74848),r=n(28453);const o={title:"Upgrade Keycloak v17.0 to 19.0",description:"Guide on upgrading Keycloak from version 17.0.x-legacy to 19.0.x on Kubernetes, detailing prerequisites, database migration strategies, and Keycloak configuration adjustments.",sidebar_label:"Upgrade Keycloak to 19.0"},l="Upgrade Keycloak v17.0 to 19.0",i={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Upgrade Postgres Database to a Minor Release v.11.17",id:"upgrade-postgres-database-to-a-minor-release-v1117",level:2},{value:"Delete Keycloak Resources",id:"delete-keycloak-resources",level:3},{value:"Upgrade Keycloak",id:"upgrade-keycloak",level:3},{value:"Install Postgres",id:"install-postgres",level:3},{value:"Clean and Analyze Database",id:"clean-and-analyze-database",level:3},{value:"Migrate Postgres Database From Postgres v.11.x to v.14.5",id:"migrate-postgres-database-from-postgres-v11x-to-v145",level:2},{value:"Export Postgres Databases",id:"export-postgres-databases",level:3},{value:"Delete Keycloak Resources",id:"delete-keycloak-resources-1",level:3},{value:"Install Postgres",id:"install-postgres-1",level:3},{value:"Import Postgres Databases",id:"import-postgres-databases",level:3},{value:"Install Keycloak",id:"install-keycloak",level:3},{value:"Clean and Analyze Database",id:"clean-and-analyze-database-1",level:3},{value:"Postgres Database Migration Script",id:"postgres-database-migration-script",level:3},{value:"Related Articles",id:"related-articles",level:2}];function c(e){const s={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components},{Details:n,Head:a}=s;return n||p("Details",!0),a||p("Head",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"upgrade-keycloak-v170-to-190",children:"Upgrade Keycloak v17.0 to 19.0"})}),"\n",(0,t.jsx)(a,{children:(0,t.jsx)("link",{rel:"canonical",href:"https://docs.kuberocketci.io/docs/operator-guide/upgrade/upgrade-keycloak-19.0/"})}),"\n",(0,t.jsxs)(s.p,{children:["Starting from Keycloak v.18.x.x, the Keycloak server has been moved from the Wildfly (JBoss) Application Server to ",(0,t.jsx)(s.a,{href:"https://quarkus.io/",children:"Quarkus"})," framework and is called Keycloak.X."]}),"\n",(0,t.jsxs)(s.p,{children:["There are two ways to upgrade Keycloak v.17.0.x-legacy to v.19.0.x on Kubernetes, please perform the steps described in the ",(0,t.jsx)(s.a,{href:"#prerequisites",children:"Prerequisites"})," section of this tutorial, and then select a suitable upgrade strategy for your environment:"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"#upgrade-postgres-database-to-a-minor-release-v1117",children:"Upgrade Postgres database to a minor release v.11.17"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"#migrate-postgres-database-from-postgres-v11x-to-v145",children:"Migrate Postgres database from Postgres v.11.x to v.14.5"})}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsx)(s.p,{children:"Before upgrading Keycloak, please perform the steps below:"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Create a backup/snapshot of the Keycloak database volume. Locate the AWS ",(0,t.jsx)(s.code,{children:"volumeID"})," and then create its ",(0,t.jsx)(s.a,{href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html",children:"snapshot"})," on AWS:"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Find the ",(0,t.jsx)(s.code,{children:"PVC"})," name attached to the Postgres pod. It can be similar to ",(0,t.jsx)(s.code,{children:"data-keycloak-postgresql-0"})," if the Postgres ",(0,t.jsx)(s.code,{children:"StatefulSet"})," name is ",(0,t.jsx)(s.code,{children:"keycloak-postgresql"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl get pods keycloak-postgresql-0 -n security -o jsonpath='{.spec.volumes[*].persistentVolumeClaim.claimName}{\"\\n\"}'\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Locate the ",(0,t.jsx)(s.code,{children:"PV"})," ",(0,t.jsx)(s.code,{children:"volumeName"})," in the ",(0,t.jsx)(s.code,{children:"data-keycloak-postgresql-0"})," Persistent Volume Claim:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl get pvc data-keycloak-postgresql-0 -n security -o jsonpath='{.spec.volumeName}{\"\\n\"}'\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Get ",(0,t.jsx)(s.code,{children:"volumeID"})," in the Persistent Volume:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl get pv ${pv_name} -n security -o jsonpath='{.spec.awsElasticBlockStore.volumeID}{\"\\n\"}'\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Add two additional keys: ",(0,t.jsx)(s.code,{children:"password"})," and ",(0,t.jsx)(s.code,{children:"postgres-password"}),", to the ",(0,t.jsx)(s.code,{children:"keycloak-postgresql"})," secret in the Keycloak namespace."]}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["The ",(0,t.jsx)(s.code,{children:"password"})," key must have the same value as the ",(0,t.jsx)(s.code,{children:"postgresql-password"})," key."]}),"\n",(0,t.jsxs)(s.li,{children:["The ",(0,t.jsx)(s.code,{children:"postgres-password"})," key must have the same value as the ",(0,t.jsx)(s.code,{children:"postgresql-postgres-password"})," key."]}),"\n"]})}),"\n",(0,t.jsxs)(s.p,{children:["The latest chart for Keycloak.X does not have an option to override Postgres password and admin password keys in the secret, and it uses the Postgres ",(0,t.jsx)(s.a,{href:"https://github.com/codecentric/helm-charts/blob/master/charts/keycloakx/values.yaml#L371",children:"defaults"}),", therefore, a new secret scheme must be implemented:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl -n security edit secret keycloak-postgresql\n"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:"data:\n  postgresql-password: XXXXXX\n  postgresql-postgres-password: YYYYYY\n  password: XXXXXX\n  postgres-password: YYYYYY\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Save Keycloak ",(0,t.jsx)(s.code,{children:"StatefulSet"})," names, for example, ",(0,t.jsx)(s.code,{children:"keycloak"})," and ",(0,t.jsx)(s.code,{children:"keycloak-postgresql"}),". These names will be used in the new Helm deployments:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"$ kubectl get statefulset -n security\nNAME                  READY   AGE\nkeycloak              1/1     18h\nkeycloak-postgresql   1/1     18h\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"upgrade-postgres-database-to-a-minor-release-v1117",children:"Upgrade Postgres Database to a Minor Release v.11.17"}),"\n",(0,t.jsxs)(s.p,{children:["To upgrade Keycloak by upgrading ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/",children:"Postgres Database"})," to a minor release v.11.17, perform the steps described in the ",(0,t.jsx)(s.a,{href:"#prerequisites",children:"Prerequisites"})," section of this tutorial, and then perform the following steps:"]}),"\n",(0,t.jsx)(s.h3,{id:"delete-keycloak-resources",children:"Delete Keycloak Resources"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Delete ",(0,t.jsx)(s.code,{children:"Keycloak"})," and ",(0,t.jsx)(s.code,{children:"Postgres"})," ",(0,t.jsx)(s.code,{children:"StatefulSets"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl delete statefulset keycloak keycloak-postgresql -n security\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Delete the Keycloak ",(0,t.jsx)(s.code,{children:"Ingress"}),"object, to prevent hostname duplication issues:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl delete ingress keycloak -n security\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"upgrade-keycloak",children:"Upgrade Keycloak"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Make sure the Keycloak chart repository is added:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm repo add codecentric https://codecentric.github.io/helm-charts\nhelm repo update\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Create values for Keycloak:"}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsx)(s.p,{children:"Since the Keycloak.X release, Keycloak  and Postgres database charts are separated.\nUpgrade Keycloak, and then install the Postgres database."})}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:'nameOverride: "keycloak"'})," sets the name of the Keycloak pod. It must be the same Keycloak name as in the previous ",(0,t.jsx)(s.code,{children:"StatefulSet"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Change Ingress host name to the Keycloak host name."}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"hostname: keycloak-postgresql"})," is the hostname of the pod with the Postgres database that is the same as Postgres StatefulSet name, for example, ",(0,t.jsx)(s.code,{children:"keycloak-postgresql"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:'"/opt/keycloak/bin/kc.sh start --auto-build"'})," was used in the legacy Keycloak version. However, it is no longer required in the new Keycloak version since it is ",(0,t.jsx)(s.a,{href:"https://www.keycloak.org/docs/latest/upgrading/index.html#changes-to-the-server-configuration-and-startup",children:"deprecated"})," and used by default."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Optionally, use the following command for applying the old Keycloak theme:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"bin/kc.sh start --features-disabled=admin2\n"})}),"\n"]}),"\n"]})}),"\n",(0,t.jsxs)(n,{children:[(0,t.jsx)("summary",{children:(0,t.jsx)("b",{children:"View: keycloak-values.yaml"})}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'nameOverride: "keycloak"\n\nreplicas: 1\n\n# Deploy the latest verion\nimage:\n  tag: "19.0.1"\n\n# start: create OpenShift realm which is required by KubeRocketCI\nextraInitContainers: |\n  - name: realm-provider\n    image: busybox\n    imagePullPolicy: IfNotPresent\n    command:\n      - sh\n    args:\n      - -c\n      - |\n        echo \'{"realm": "openshift","enabled": true}\' > /opt/keycloak/data/import/openshift.json\n    volumeMounts:\n      - name: realm\n        mountPath: /opt/keycloak/data/import\n\nextraVolumeMounts: |\n  - name: realm\n    mountPath: /opt/keycloak/data/import\n\nextraVolumes: |\n  - name: realm\n    emptyDir: {}\n\ncommand:\n  - "/opt/keycloak/bin/kc.sh"\n  - "--verbose"\n  - "start"\n  - "--http-enabled=true"\n  - "--http-port=8080"\n  - "--hostname-strict=false"\n  - "--hostname-strict-https=false"\n  - "--spi-events-listener-jboss-logging-success-level=info"\n  - "--spi-events-listener-jboss-logging-error-level=warn"\n  - "--import-realm"\n\nextraEnv: |\n  - name: KC_PROXY\n    value: "passthrough"\n  - name: KEYCLOAK_ADMIN\n    valueFrom:\n      secretKeyRef:\n        name: keycloak-admin-creds\n        key: username\n  - name: KEYCLOAK_ADMIN_PASSWORD\n    valueFrom:\n      secretKeyRef:\n        name: keycloak-admin-creds\n        key: password\n  - name: JAVA_OPTS_APPEND\n    value: >-\n      -XX:+UseContainerSupport\n      -XX:MaxRAMPercentage=50.0\n      -Djava.awt.headless=true\n      -Djgroups.dns.query={{ include "keycloak.fullname" . }}-headless\n\n# This block should be uncommented if you install Keycloak on Kubernetes\ningress:\n  enabled: true\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    ingress.kubernetes.io/affinity: cookie\n  rules:\n    - host: keycloak.<ROOT_DOMAIN>\n      paths:\n        - path: \'{{ tpl .Values.http.relativePath $ | trimSuffix "/" }}/\'\n          pathType: Prefix\n\n# This block should be uncommented if you set Keycloak to OpenShift and change the host field\n# route:\n#   enabled: false\n#   # Path for the Route\n#   path: \'/\'\n#   # Host name for the Route\n#   host: "keycloak.<ROOT_DOMAIN>"\n#   # TLS configuration\n#   tls:\n#     enabled: true\n\nresources:\n  limits:\n    memory: "2048Mi"\n  requests:\n    cpu: "50m"\n    memory: "512Mi"\n\n# Check database readiness at startup\ndbchecker:\n  enabled: true\n\ndatabase:\n  vendor: postgres\n  existingSecret: keycloak-postgresql\n  hostname: keycloak-postgresql\n  port: 5432\n  username: admin\n  database: keycloak\n'})})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Upgrade the Keycloak Helm chart:"}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"The Helm chart is substituted with the new KeyacloakX instance."}),"\n",(0,t.jsx)(s.li,{children:"Change the namespace and the values file name if required."}),"\n"]})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm upgrade keycloak codecentric/keycloakx --version 1.6.0 --values keycloak-values.yaml -n security\n"})}),"\n",(0,t.jsxs)(s.admonition,{type:"note",children:[(0,t.jsxs)(s.p,{children:["If there are error messages when upgrading via Helm, make sure that ",(0,t.jsx)(s.code,{children:"StatefulSets"})," are removed. If they are removed and the error still persists, try to add the ",(0,t.jsx)(s.code,{children:"--force"})," flag to the Helm command:"]}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm upgrade keycloak codecentric/keycloakx --version 1.6.0 --values keycloak-values.yaml -n security --force\n"})})]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"install-postgres",children:"Install Postgres"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Add Bitnami chart repository and update Helm repos:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm repo add bitnami https://charts.bitnami.com/bitnami\nhelm repo update\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Create values for Postgres:"}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Postgres v.11 and Postgres v.14.5 are not compatible."}),"\n",(0,t.jsx)(s.li,{children:"Postgres image will be upgraded to a minor release v.11.17."}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:'fullnameOverride: "keycloak-postgresql"'})," sets the name of the Postgres StatefulSet. It must be the same as in the previous ",(0,t.jsx)(s.code,{children:"StatefulSet"}),"."]}),"\n"]})}),"\n",(0,t.jsxs)(n,{children:[(0,t.jsx)("summary",{children:(0,t.jsx)("b",{children:"View: postgres-values.yaml"})}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'fullnameOverride: "keycloak-postgresql"\n\n# PostgreSQL read only replica parameters\nreadReplicas:\n  # Number of PostgreSQL read only replicas\n  replicaCount: 1\n\nglobal:\n  postgresql:\n    auth:\n      username: admin\n      existingSecret: keycloak-postgresql\n      secretKeys:\n        adminPasswordKey: postgres-password\n        userPasswordKey: password\n      database: keycloak\n\nimage:\n  registry: docker.io\n  repository: bitnami/postgresql\n  tag: 11.17.0-debian-11-r3\n\nauth:\n  existingSecret: keycloak-postgresql\n  secretKeys:\n    adminPasswordKey: postgres-password\n    userPasswordKey: password\n\nprimary:\n  persistence:\n    enabled: true\n    size: 3Gi\n    # If the StorageClass with reclaimPolicy: Retain is used, install an additional StorageClass before installing PostgreSQL\n    # (the code is given below).\n    # If the default StorageClass will be used - change "gp2-retain" to "gp2"\n    storageClass: "gp2-retain"\n'})})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Install the Postgres database chart:"}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsx)(s.p,{children:"Change the namespace and the values file name if required."})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm install postgresql bitnami/postgresql \\\n--version 11.7.6 \\\n--values postgres-values.yaml \\\n--namespace security\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Log in to Keycloak and check that everything works as expected."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"clean-and-analyze-database",children:"Clean and Analyze Database"}),"\n",(0,t.jsxs)(s.p,{children:["Optionally, run the ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/docs/current/app-vacuumdb.html",children:"vacuumdb"}),' application on the database, to recover space occupied by "dead tuples" in the tables, analyze the contents of database tables, and collect statistics for PostgreSQL query engine to improve performance:']}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'PGPASSWORD="${postgresql_postgres-password}" vacuumdb --analyze --verbose -d keycloak -U postgres\n'})}),"\n",(0,t.jsx)(s.p,{children:"For all databases, run the following command:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'PGPASSWORD="${postgresql_postgres-password}" vacuumdb --analyze --verbose --all -U postgres\n'})}),"\n",(0,t.jsx)(s.h2,{id:"migrate-postgres-database-from-postgres-v11x-to-v145",children:"Migrate Postgres Database From Postgres v.11.x to v.14.5"}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsxs)(s.p,{children:["There is a ",(0,t.jsx)(s.a,{href:"#postgres-database-migration-script",children:"Postgres database migration script"})," at the end of this tutorial. Please read the section below before using the script."]})}),"\n",(0,t.jsxs)(s.p,{children:["To upgrade Keycloak by migrating Postgres database from Postgres v.11.x to v.14.5, perform the steps described in the ",(0,t.jsx)(s.a,{href:"#prerequisites",children:"Prerequisites"})," section of this tutorial, and then perform the following steps:"]}),"\n",(0,t.jsx)(s.h3,{id:"export-postgres-databases",children:"Export Postgres Databases"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Log in to the current Keycloak Postgres pod and create a logical backup of all roles and databases using the ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/docs/current/app-pg-dumpall.html",children:"pg_dumpall"})," application. If there is no access to the Postgres Superuser, backup the Keycloak database with the ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/docs/current/app-pgdump.html",children:"pg_dump"})," application:"]}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["The secret key ",(0,t.jsx)(s.code,{children:"postgresql-postgres-password"})," is for the ",(0,t.jsx)(s.code,{children:"postgres"})," Superuser and ",(0,t.jsx)(s.code,{children:"postgresql-password"})," is for ",(0,t.jsx)(s.code,{children:"admin"})," user. The ",(0,t.jsx)(s.code,{children:"admin"})," user is indicated by default in the Postgres Helm chart.",(0,t.jsx)("br",{}),"\nThe ",(0,t.jsx)(s.code,{children:"admin"})," user may not have enough permissions to dump all Postgres databases and roles, so the preferred option for exporting all objects is using the ",(0,t.jsx)(s.code,{children:"pg_dumpall"})," tool with the ",(0,t.jsx)(s.code,{children:"postgres"})," Superuser.",(0,t.jsx)("br",{})]}),"\n",(0,t.jsxs)(s.li,{children:["If the ",(0,t.jsx)(s.code,{children:"PGPASSWORD"})," variable is not specified before using the ",(0,t.jsx)(s.code,{children:"pg_dumpall"})," tool, you will be prompted to enter a password for each database during the export."]}),"\n",(0,t.jsxs)(s.li,{children:["If the ",(0,t.jsx)(s.code,{children:"-l keycloak"})," parameter is specified, ",(0,t.jsx)(s.code,{children:"pg_dumpall"})," will connect to the ",(0,t.jsx)(s.code,{children:"keycloak"})," database for dumping global objects and discovering what other databases should be dumped. By default, ",(0,t.jsx)(s.code,{children:"pg_dumpall"})," will try to connect to ",(0,t.jsx)(s.code,{children:"postgres"})," or ",(0,t.jsx)(s.code,{children:"template1"})," databases. This parameter is optional."]}),"\n",(0,t.jsxs)(s.li,{children:["The ",(0,t.jsx)(s.code,{children:"pg_dumpall --clean"})," option adds SQL commands to the dumped file for dropping databases before recreating them during import, as well as ",(0,t.jsx)(s.code,{children:"DROP"})," commands for roles and tablespaces (",(0,t.jsx)(s.code,{children:"pg_dump"})," also has this option). If the ",(0,t.jsx)(s.code,{children:"--clean"})," parameter is specified, connect to the ",(0,t.jsx)(s.code,{children:"postgres"})," database initially during import via ",(0,t.jsx)(s.code,{children:"psql"}),". The ",(0,t.jsx)(s.code,{children:"psql"})," script will attempt to drop other databases immediately, and that will fail for the database you are connected to. This flag is optional, and it is not included into this tutorial."]}),"\n"]})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'PGPASSWORD="${postgresql_postgres-password}" pg_dumpall -h localhost -p 5432 -U postgres -l keycloak > /tmp/keycloak_wildfly_db_dump.sql\n'})}),"\n",(0,t.jsxs)(s.admonition,{type:"note",children:[(0,t.jsxs)(s.p,{children:["If there is no working password for the ",(0,t.jsx)(s.code,{children:"postgres"})," Superuser, try the ",(0,t.jsx)(s.code,{children:"admin"})," user using the ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/docs/current/app-pgdump.html",children:"pg_dump"})," tool to export the ",(0,t.jsx)(s.code,{children:"keycloak"})," database without global roles:"]}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'PGPASSWORD="${postgresql_password}" pg_dump -h localhost -p 5432 -U admin -d keycloak > /tmp/keycloak_wildfly_db_dump.sql\n'})})]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.p,{children:"Double-check that the contents of the dumped file is not empty. It usually contains more than 4000 lines."})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Copy the file with the database dump to a local machine. Since ",(0,t.jsx)(s.code,{children:"tar"})," may not be present in the pod and ",(0,t.jsx)(s.code,{children:"kubectl cp"})," will not work without ",(0,t.jsx)(s.code,{children:"tar"}),", use the following command:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl exec -n security ${postgresql_pod} -- cat /tmp/keycloak_wildfly_db_dump.sql  > keycloak_wildfly_db_dump.sql\n"})}),"\n",(0,t.jsxs)(s.admonition,{type:"note",children:[(0,t.jsx)(s.p,{children:"Please find below the alternative commands for exporting the database to the local machine without copying the file to a pod for Postgres and admin users:"}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'kubectl exec -n security ${postgresql_pod} "--" sh -c "PGPASSWORD=\'"${postgresql_postgres-password}"\' pg_dumpall -h localhost -p 5432 -U postgres" > keycloak_wildfly_db_dump.sql\nkubectl exec -n security ${postgresql_pod} "--" sh -c "PGPASSWORD=\'"${postgresql_password}"\' pg_dump -h localhost -p 5432 -U admin -d keycloak" > keycloak_wildfly_db_dump.sql\n'})})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Delete the dumped file from the pod for security reasons:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'kubectl exec -n security ${postgresql_pod} "--" sh -c "rm /tmp/keycloak_wildfly_db_dump.sql"\n'})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"delete-keycloak-resources-1",children:"Delete Keycloak Resources"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Delete all previous Keycloak resources along with the Postgres database and keycloak ",(0,t.jsx)(s.code,{children:"StatefulSets"}),", ",(0,t.jsx)(s.code,{children:"Ingress"}),", and custom resources via Helm, or via the tool used for their deployment."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm list -n security\nhelm delete keycloak -n security\n"})}),"\n",(0,t.jsx)(s.admonition,{type:"warning",children:(0,t.jsxs)(s.p,{children:["Don't delete the whole namespace. Keep the ",(0,t.jsx)(s.code,{children:"keycloak-postgresql"})," and ",(0,t.jsx)(s.code,{children:"keycloak-admin-creds"})," secrets."]})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Delete the volume in AWS, from which a snapshot has been created. Then delete the PVC:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl delete pvc data-keycloak-postgresql-0 -n security\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"install-postgres-1",children:"Install Postgres"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Add Bitnami chart repository and update Helm repos:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm repo add bitnami https://charts.bitnami.com/bitnami\nhelm repo update\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Create Postgres values:"}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:'fullnameOverride: "keycloak-postgresql"'})," sets the name of the Postgres StatefulSet. It must be same as in the previous ",(0,t.jsx)(s.code,{children:"StatefulSet"}),"."]})}),"\n",(0,t.jsxs)(n,{children:[(0,t.jsx)("summary",{children:(0,t.jsx)("b",{children:"View: postgres-values.yaml"})}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'nameOverride: "keycloak-postgresql"\n\n# PostgreSQL read only replica parameters\nreadReplicas:\n  # Number of PostgreSQL read only replicas\n  replicaCount: 1\n\nglobal:\n  postgresql:\n    auth:\n      username: admin\n      existingSecret: keycloak-postgresql\n      secretKeys:\n        adminPasswordKey: postgres-password\n        userPasswordKey: password\n      database: keycloak\n\nauth:\n  existingSecret: keycloak-postgresql\n  secretKeys:\n    adminPasswordKey: postgres-password\n    userPasswordKey: password\n\nprimary:\n  persistence:\n    enabled: true\n    size: 3Gi\n    # If the StorageClass with reclaimPolicy: Retain is used, install an additional StorageClass before installing PostgreSQL\n    # (the code is given below).\n    # If the default StorageClass will be used - change "gp2-retain" to "gp2"\n    storageClass: "gp2-retain"\n'})})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Install the Postgres database:"}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsx)(s.p,{children:"Change the namespace and the values file name if required."})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm install postgresql bitnami/postgresql \\\n  --version 11.7.6 \\\n  --values postgres-values.yaml \\\n  --namespace security\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Wait for the database to be ready."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"import-postgres-databases",children:"Import Postgres Databases"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Upload the database dump to the new Keycloak Postgres pod:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'cat keycloak_wildfly_db_dump.sql | kubectl exec -i -n security ${postgresql_pod} "--" sh -c "cat > /tmp/keycloak_wildfly_db_dump.sql"\n'})}),"\n",(0,t.jsxs)(s.admonition,{type:"warning",children:[(0,t.jsxs)(s.p,{children:["Database import must be done before deploying Keycloak, because Keycloak will write its own data to the database during the start, and the import will partially fail.",(0,t.jsx)("br",{}),"\nIf that happened, scale down the keycloak ",(0,t.jsx)(s.code,{children:"StatefulSet"}),", and try to drop the Keycloak database in the Postgres pod:"]}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"dropdb -i -e keycloak -p 5432 -h localhost -U postgres\n"})}),(0,t.jsxs)(s.p,{children:["If there still are some conflicting objects like roles, drop them via the ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/docs/current/sql-droprole.html",children:"DROP ROLE"})," command."]}),(0,t.jsxs)(s.p,{children:["If the previous steps do not help, downscale the Keycloak and Postgres ",(0,t.jsx)(s.code,{children:"StatefulSets"})," and delete the attached ",(0,t.jsx)(s.code,{children:"PVC"})," (save the ",(0,t.jsx)(s.code,{children:"volumeID"})," before removing), and delete the volume on AWS if using ",(0,t.jsx)(s.code,{children:"gp2-retain"}),". In case of using ",(0,t.jsx)(s.code,{children:"gp2"}),", the volume will be deleted automatically after removing PVC. After that, redeploy the Postgres database, so that the new ",(0,t.jsx)(s.code,{children:"PVC"})," is automatically created."]})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Import the ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/docs/current/backup-dump.html",children:"SQL dump"})," file to the Postgres database cluster:"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsxs)(s.p,{children:["Since the databases were exported in the ",(0,t.jsx)(s.code,{children:"sql"})," format, the ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/docs/current/app-psql.html",children:"psql"})," tool will be used to restore (reload) them. ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/docs/current/app-pgrestore.html",children:"pg_restore"})," does not support this plain-text format."]})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["If the entire Postgres database cluster was migrated with the ",(0,t.jsx)(s.code,{children:"postgres"})," Superuser using ",(0,t.jsx)(s.code,{children:"pg_dumpall"}),", use the import command without indicating the database:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"psql -U postgres -f /tmp/keycloak_wildfly_db_dump.sql\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["If the database was migrated with the ",(0,t.jsx)(s.code,{children:"admin"})," user using ",(0,t.jsx)(s.code,{children:"pg_dump"}),", the ",(0,t.jsx)(s.code,{children:"postgres"})," Superuser still can be used to restore it, but, in this case, a database must be indicated:"]}),"\n",(0,t.jsx)(s.admonition,{type:"warning",children:(0,t.jsxs)(s.p,{children:["If the database name was not indicated during the import for the file dumped with ",(0,t.jsx)(s.code,{children:"pg_dump"}),", the ",(0,t.jsx)(s.code,{children:"psql"})," tool will import this database to a default Postgres database called ",(0,t.jsx)(s.code,{children:"postgres"}),"."]})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"psql -U postgres -d keycloak -f /tmp/keycloak_wildfly_db_dump.sql\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["If the ",(0,t.jsx)(s.code,{children:"postgres"})," Superuser is not accessible in the Postgres pod, run the command under the ",(0,t.jsx)(s.code,{children:"admin"})," or any other user that has the database permissions. In this case, indicate the database as well:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"psql -U admin -d keycloak -f /tmp/keycloak_wildfly_db_dump.sql\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"After a successful import, delete the dump file from the pod for security reasons:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'kubectl exec -n security ${postgresql_pod} "--" sh -c "rm /tmp/keycloak_wildfly_db_dump.sql"\n'})}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsxs)(s.p,{children:["Please find below the alternative commands for importing the database from the local machine to the pod without storing the backup on a pod for ",(0,t.jsx)(s.code,{children:"postgres"})," or ",(0,t.jsx)(s.code,{children:"admin"})," users:"]})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'cat "keycloak_wildfly_db_dump.sql" | kubectl exec -i -n "${keycloak_namespace}" "${postgres_pod_name}" "--" sh -c "cat | PGPASSWORD=\'"${postgresql_superuser_password}"\' psql -h "${db_host}" -p "${db_port}" -U "${postgres_username}""\ncat "keycloak_wildfly_db_dump.sql" | kubectl exec -i -n "${keycloak_namespace}" "${postgres_pod_name}" "--" sh -c "cat | PGPASSWORD=\'"${postgresql_superuser_password}"\' psql -h "${db_host}" -p "${db_port}" -U "${postgres_username}" -d "${database_name}""\ncat "keycloak_wildfly_db_dump.sql" | kubectl exec -i -n "${keycloak_namespace}" "${postgres_pod_name}" "--" sh -c "cat | PGPASSWORD=\'"${postgresql_admin_password}"\' psql -h "${db_host}" -p "${db_port}" -U "${postgres_username}" -d "${database_name}""\n'})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"install-keycloak",children:"Install Keycloak"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Make sure the Keycloak chart repository is added:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm repo add codecentric https://codecentric.github.io/helm-charts\nhelm repo update\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Create Keycloak values:"}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:'nameOverride: "keycloak"'})," sets the name of the Keycloak pod. It must be the same Keycloak name as in the previous ",(0,t.jsx)(s.code,{children:"StatefulSet"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Change Ingress host name to the Keycloak host name."}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"hostname: keycloak-postgresql"})," is the hostname of the pod with the Postgres database that is the same as Postgres StatefulSet name, for example, ",(0,t.jsx)(s.code,{children:"keycloak-postgresql"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:'"/opt/keycloak/bin/kc.sh start --auto-build"'})," was used in the legacy Keycloak version. However, it is no longer required in the new Keycloak version since it is ",(0,t.jsx)(s.a,{href:"https://www.keycloak.org/docs/latest/upgrading/index.html#changes-to-the-server-configuration-and-startup",children:"deprecated"})," and used by default."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Optionally, use the following command for applying the old Keycloak theme:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"bin/kc.sh start --features-disabled=admin2\n"})}),"\n"]}),"\n"]})}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.a,{href:"https://www.keycloak.org/docs/latest/upgrading/index.html#automatic-relational-database-migration",children:"Automatic database migration"})," will start after the Keycloak installation."]})}),"\n",(0,t.jsxs)(n,{children:[(0,t.jsx)("summary",{children:(0,t.jsx)("b",{children:"View: keycloak-values.yaml"})}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'nameOverride: "keycloak"\n\nreplicas: 1\n\n# Deploy the latest version\nimage:\n  tag: "19.0.1"\n\n# start: create OpenShift realm which is required by KubeRocketCI\nextraInitContainers: |\n  - name: realm-provider\n    image: busybox\n    imagePullPolicy: IfNotPresent\n    command:\n      - sh\n    args:\n      - -c\n      - |\n        echo \'{"realm": "openshift","enabled": true}\' > /opt/keycloak/data/import/openshift.json\n    volumeMounts:\n      - name: realm\n        mountPath: /opt/keycloak/data/import\n\nextraVolumeMounts: |\n  - name: realm\n    mountPath: /opt/keycloak/data/import\n\nextraVolumes: |\n  - name: realm\n    emptyDir: {}\n\ncommand:\n  - "/opt/keycloak/bin/kc.sh"\n  - "--verbose"\n  - "start"\n  - "--http-enabled=true"\n  - "--http-port=8080"\n  - "--hostname-strict=false"\n  - "--hostname-strict-https=false"\n  - "--spi-events-listener-jboss-logging-success-level=info"\n  - "--spi-events-listener-jboss-logging-error-level=warn"\n  - "--import-realm"\n\nextraEnv: |\n  - name: KC_PROXY\n    value: "passthrough"\n  - name: KEYCLOAK_ADMIN\n    valueFrom:\n      secretKeyRef:\n        name: keycloak-admin-creds\n        key: username\n  - name: KEYCLOAK_ADMIN_PASSWORD\n    valueFrom:\n      secretKeyRef:\n        name: keycloak-admin-creds\n        key: password\n  - name: JAVA_OPTS_APPEND\n    value: >-\n      -XX:+UseContainerSupport\n      -XX:MaxRAMPercentage=50.0\n      -Djava.awt.headless=true\n      -Djgroups.dns.query={{ include "keycloak.fullname" . }}-headless\n\n# This block should be uncommented if you install Keycloak on Kubernetes\ningress:\n  enabled: true\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    ingress.kubernetes.io/affinity: cookie\n  rules:\n    - host: keycloak.<ROOT_DOMAIN>\n      paths:\n        - path: \'{{ tpl .Values.http.relativePath $ | trimSuffix "/" }}/\'\n          pathType: Prefix\n\n# This block should be uncommented if you set Keycloak to OpenShift and change the host field\n# route:\n#   enabled: false\n#   # Path for the Route\n#   path: \'/\'\n#   # Host name for the Route\n#   host: "keycloak.<ROOT_DOMAIN>"\n#   # TLS configuration\n#   tls:\n#     enabled: true\n\nresources:\n  limits:\n    memory: "2048Mi"\n  requests:\n    cpu: "50m"\n    memory: "512Mi"\n\n# Check database readiness at startup\ndbchecker:\n  enabled: true\n\ndatabase:\n  vendor: postgres\n  existingSecret: keycloak-postgresql\n  hostname: keycloak-postgresql\n  port: 5432\n  username: admin\n  database: keycloak\n'})})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Deploy Keycloak:"}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsx)(s.p,{children:"Change the namespace and the values file name if required."})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm install keycloak codecentric/keycloakx --version 1.6.0 --values keycloak-values.yaml -n security\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Log in to Keycloak and check if everything has been imported correctly."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"clean-and-analyze-database-1",children:"Clean and Analyze Database"}),"\n",(0,t.jsxs)(s.p,{children:["Optionally, run the ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/docs/current/app-vacuumdb.html",children:"vacuumdb"})," application on the database, to analyze the contents of database tables and collect statistics for the Postgres query optimizer:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'PGPASSWORD="${postgresql_postgres-password}" vacuumdb --analyze --verbose -d keycloak -U postgres\n'})}),"\n",(0,t.jsx)(s.p,{children:"For all databases, run the following command:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'PGPASSWORD="${postgresql_postgres-password}" vacuumdb --analyze --verbose --all -U postgres\n'})}),"\n",(0,t.jsx)(s.h3,{id:"postgres-database-migration-script",children:"Postgres Database Migration Script"}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsxs)(s.p,{children:["Please read the ",(0,t.jsx)(s.a,{href:"#migrate-postgres-database-from-postgres-v11x-to-v145",children:"Migrate Postgres Database From Postgres v.11.x to v.14.5"})," section of this tutorial before using the script."]})}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["The ",(0,t.jsx)(s.a,{href:"https://github.com/kubernetes/kubectl",children:(0,t.jsx)(s.code,{children:"kubectl"})})," tool is required for using this script."]}),"\n",(0,t.jsxs)(s.li,{children:["This script will likely work for any other Postgres database besides Keycloak after some adjustments. It queries the ",(0,t.jsx)(s.code,{children:"pg_dump"}),", ",(0,t.jsx)(s.code,{children:"pg_dumpall"}),", ",(0,t.jsx)(s.code,{children:"psql"}),", and ",(0,t.jsx)(s.code,{children:"vacuumdb"})," commands under the hood."]}),"\n"]})}),"\n",(0,t.jsxs)(s.p,{children:["The following script can be used for exporting and importing Postgres databases as well as optimizing them with the ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/docs/current/app-vacuumdb.html",children:"vacuumdb"})," application. Please examine the code and make the adjustments if required."]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"By default, the following command exports Keycloak Postgres databases from a Kubernetes pod to a local machine:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"./script.sh\n"})}),"\n",(0,t.jsx)(s.p,{children:"After running the command, please follow the prompt."}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"To import a database backup to a newly created Postgres Kubernetes pod, pass a database dump sql file to the script:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"  ./script.sh path-to/db_dump.sql\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.code,{children:"-h"})," flag prints help, and ",(0,t.jsx)(s.code,{children:"-c|-v"})," runs the ",(0,t.jsx)(s.code,{children:"vacuumdb"})," garbage collector and analyzer."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n,{children:[(0,t.jsx)("summary",{children:(0,t.jsx)("b",{children:"View: keycloak_db_migration.sh"})}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'#!/bin/bash\n\n# set -x\n\ndb_migration_help(){\n    echo "Keycloak Postgres database migration"\n    echo\n    echo "Usage:"\n    echo "------------------------------------------"\n    echo "Export Keycloak Postgres database from pod"\n    echo "Run without parameters:"\n    echo "      $0"\n    echo "------------------------------------------"\n    echo "Import Keycloak Postgres database to pod"\n    echo "Pass filename to script:"\n    echo "      $0 path/to/db_dump.sql"\n    echo "------------------------------------------"\n    echo "Additional options: "\n    echo "      $0 [OPTIONS...]"\n    echo "Options:"\n    echo "h     Print Help."\n    echo "c|v   Run garbage collector and analyzer."\n}\n\nkeycloak_ns(){\n    printf \'%s\\n\' \'Enter keycloak namespace: \'\n    read -r keycloak_namespace\n\n    if [ -z "${keycloak_namespace}" ]; then\n        echo "Don\'t skip namespace"\n        exit 1\n    fi\n}\n\npostgres_pod(){\n    printf \'%s\\n\' \'Enter postgres pod name: \'\n    read -r postgres_pod_name\n\n    if [ -z "${postgres_pod_name}" ]; then\n        echo "Don\'t skip pod name"\n        exit 1\n    fi\n}\n\npostgres_user(){\n    printf \'%s\\n\' \'Enter postgres username: \'\n    printf \'%s\' "Skip to use [postgres] superuser: "\n    read -r postgres_username\n\n    if [ -z "${postgres_username}" ]; then\n        postgres_username=\'postgres\'\n    fi\n}\n\npgdb_host_info(){\n    database_name=\'keycloak\'\n    db_host=\'localhost\'\n    db_port=\'5432\'\n}\n\npostgresql_admin_pass(){\n    postgresql_password=\'POSTGRES_PASSWORD\'\n    postgresql_admin_password="$(kubectl exec -n "${keycloak_namespace}" "${postgres_pod_name}" "--" \\\n        sh -c "printenv ${postgresql_password}")"\n}\n\npostgresql_su_pass(){\n    postgresql_postgres_password=\'POSTGRES_POSTGRES_PASSWORD\'\n    postgresql_superuser_password="$(kubectl exec -n "${keycloak_namespace}" "${postgres_pod_name}" "--" \\\n        sh -c "printenv ${postgresql_postgres_password}")"\n\n    if [ -z "${postgresql_superuser_password}" ]; then\n        echo "SuperUser password variable does not exist. Using user password instead..."\n        postgresql_admin_pass\n        postgresql_superuser_password="${postgresql_admin_password}"\n    fi\n}\n\nkeycloak_pgdb_export(){\n    current_cluster="$(kubectl config current-context | tr -dc \'[:alnum:]-\')"\n    exported_db_name="keycloak_db_dump_${current_cluster}_${keycloak_namespace}_${postgres_username}_$(date +"%Y%m%d%H%M").sql"\n\n    if [ "${postgres_username}" == \'postgres\' ]; then\n        # call a function to get a pass for postgres user\n        postgresql_su_pass\n        kubectl exec -n "${keycloak_namespace}" "${postgres_pod_name}" "--" \\\n            sh -c "PGPASSWORD=\'"${postgresql_superuser_password}"\' pg_dumpall -h "${db_host}" -p "${db_port}" -U "${postgres_username}"" > "${exported_db_name}"\n    else\n        # call a function to get a pass for admin user\n        postgresql_admin_pass\n        kubectl exec -n "${keycloak_namespace}" "${postgres_pod_name}" "--" \\\n            sh -c "PGPASSWORD=\'"${postgresql_admin_password}"\' pg_dump -h "${db_host}" -p "${db_port}" -U "${postgres_username}" -d "${database_name}"" > "${exported_db_name}"\n    fi\n\n    separate_lines="---------------"\n\n    if [ ! -s "${exported_db_name}" ]; then\n        rm -f "${exported_db_name}"\n        echo "${separate_lines}"\n        echo "Something went wrong. The database dump file is empty and was not saved."\n    else\n        echo "${separate_lines}"\n        grep \'Dumped\' "${exported_db_name}" | sort -u\n        echo "Database has been exported to $(pwd)/${exported_db_name}"\n    fi\n}\n\nkeycloak_pgdb_import(){\n    echo "Preparing Import"\n    echo "----------------"\n\n    if [ ! -f "$1" ]; then\n        echo "The file $1 does not exist."\n        exit 1\n    fi\n\n    keycloak_ns\n    postgres_pod\n    postgres_user\n    pgdb_host_info\n\n    if [ "${postgres_username}" == \'postgres\' ]; then\n        # restore full backup with all databases and roles as superuser or a single database\n        postgresql_su_pass\n        if [ -n "$(cat "$1" | grep \'CREATE ROLE\')" ]; then\n            cat "$1" | kubectl exec -i -n "${keycloak_namespace}" "${postgres_pod_name}" "--" \\\n                sh -c "cat | PGPASSWORD=\'"${postgresql_superuser_password}"\' psql -h "${db_host}" -p "${db_port}" -U "${postgres_username}""\n        else\n            cat "$1" | kubectl exec -i -n "${keycloak_namespace}" "${postgres_pod_name}" "--" \\\n                sh -c "cat | PGPASSWORD=\'"${postgresql_superuser_password}"\' psql -h "${db_host}" -p "${db_port}" -U "${postgres_username}" -d "${database_name}""\n        fi\n    else\n        # restore a single database\n        postgresql_admin_pass\n        cat "$1" | kubectl exec -i -n "${keycloak_namespace}" "${postgres_pod_name}" "--" \\\n            sh -c "cat | PGPASSWORD=\'"${postgresql_admin_password}"\' psql -h "${db_host}" -p "${db_port}" -U "${postgres_username}" -d "${database_name}""\n    fi\n}\n\nvacuum_pgdb(){\n    echo "Preparing garbage collector and analyzer"\n    echo "----------------------------------------"\n\n    keycloak_ns\n    postgres_pod\n    postgres_user\n    pgdb_host_info\n\n    if [ "${postgres_username}" == \'postgres\' ]; then\n        postgresql_su_pass\n        kubectl exec -n "${keycloak_namespace}" "${postgres_pod_name}" "--" \\\n            sh -c "PGPASSWORD=\'"${postgresql_superuser_password}"\' vacuumdb --analyze --all -h "${db_host}" -p "${db_port}" -U "${postgres_username}""\n    else\n        postgresql_admin_pass\n        kubectl exec -n "${keycloak_namespace}" "${postgres_pod_name}" "--" \\\n            sh -c "PGPASSWORD=\'"${postgresql_admin_password}"\' vacuumdb --analyze -h "${db_host}" -p "${db_port}" -U "${postgres_username}" -d "${database_name}""\n    fi\n}\n\nwhile [ "$#" -eq 1 ]; do\n    case "$1" in\n        -h | --help)\n            db_migration_help\n            exit 0\n            ;;\n        -c | --clean | -v | --vacuum)\n            vacuum_pgdb\n            exit 0\n            ;;\n        --)\n            break\n            ;;\n        -*)\n            echo "Invalid option \'$1\'. Use -h|--help to see the valid options" >&2\n            exit 1\n            ;;\n        *)\n            keycloak_pgdb_import "$1"\n            exit 0\n            ;;\n    esac\n    shift\ndone\n\nif [ "$#" -gt 1 ]; then\n    echo "Please pass a single file to the script"\n    exit 1\nfi\n\necho "Preparing Export"\necho "----------------"\nkeycloak_ns\npostgres_pod\npostgres_user\npgdb_host_info\nkeycloak_pgdb_export\n'})})]}),"\n",(0,t.jsx)(s.h2,{id:"related-articles",children:"Related Articles"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"/docs/3.9/operator-guide/auth/keycloak",children:"Install Keycloak"})}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}function p(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},28453:(e,s,n)=>{n.d(s,{R:()=>o,x:()=>l});var a=n(96540);const t={},r=a.createContext(t);function o(e){const s=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),a.createElement(r.Provider,{value:s},e.children)}}}]);