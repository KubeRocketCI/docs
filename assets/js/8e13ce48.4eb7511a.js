"use strict";(self.webpackChunkkuberocketci_docs=self.webpackChunkkuberocketci_docs||[]).push([[86762],{7328:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/argo-cd-project-create-token-d8ab7c7b4f8a5603001acb15ffa40cba.png"},8612:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/argo-cd-create-token-confirmation-a501712a7741d573e91638c1ff308298.png"},11470:(e,n,r)=>{r.d(n,{A:()=>y});var t=r(96540),a=r(34164),s=r(17559),i=r(23104),o=r(56347),c=r(205),l=r(57485),d=r(31682),p=r(70679);function h(e){return t.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,t.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function u(e){const{values:n,children:r}=e;return(0,t.useMemo)(()=>{const e=n??function(e){return h(e).map(({props:{value:e,label:n,attributes:r,default:t}})=>({value:e,label:n,attributes:r,default:t}))}(r);return function(e){const n=(0,d.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,r])}function g({value:e,tabValues:n}){return n.some(n=>n.value===e)}function m({queryString:e=!1,groupId:n}){const r=(0,o.W6)(),a=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,l.aZ)(a),(0,t.useCallback)(e=>{if(!a)return;const n=new URLSearchParams(r.location.search);n.set(a,e),r.replace({...r.location,search:n.toString()})},[a,r])]}function j(e){const{defaultValue:n,queryString:r=!1,groupId:a}=e,s=u(e),[i,o]=(0,t.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!g({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const r=n.find(e=>e.default)??n[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:n,tabValues:s})),[l,d]=m({queryString:r,groupId:a}),[h,j]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[r,a]=(0,p.Dv)(n);return[r,(0,t.useCallback)(e=>{n&&a.set(e)},[n,a])]}({groupId:a}),x=(()=>{const e=l??h;return g({value:e,tabValues:s})?e:null})();(0,c.A)(()=>{x&&o(x)},[x]);return{selectedValue:i,selectValue:(0,t.useCallback)(e=>{if(!g({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);o(e),d(e),j(e)},[d,j,s]),tabValues:s}}var x=r(92303);const b={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var k=r(74848);function f({className:e,block:n,selectedValue:r,selectValue:t,tabValues:s}){const o=[],{blockElementScrollPositionUntilNextRender:c}=(0,i.a_)(),l=e=>{const n=e.currentTarget,a=o.indexOf(n),i=s[a].value;i!==r&&(c(n),t(i))},d=e=>{let n=null;switch(e.key){case"Enter":l(e);break;case"ArrowRight":{const r=o.indexOf(e.currentTarget)+1;n=o[r]??o[0];break}case"ArrowLeft":{const r=o.indexOf(e.currentTarget)-1;n=o[r]??o[o.length-1];break}}n?.focus()};return(0,k.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.A)("tabs",{"tabs--block":n},e),children:s.map(({value:e,label:n,attributes:t})=>(0,k.jsx)("li",{role:"tab",tabIndex:r===e?0:-1,"aria-selected":r===e,ref:e=>{o.push(e)},onKeyDown:d,onClick:l,...t,className:(0,a.A)("tabs__item",b.tabItem,t?.className,{"tabs__item--active":r===e}),children:n??e},e))})}function A({lazy:e,children:n,selectedValue:r}){const s=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=s.find(e=>e.props.value===r);return e?(0,t.cloneElement)(e,{className:(0,a.A)("margin-top--md",e.props.className)}):null}return(0,k.jsx)("div",{className:"margin-top--md",children:s.map((e,n)=>(0,t.cloneElement)(e,{key:n,hidden:e.props.value!==r}))})}function C(e){const n=j(e);return(0,k.jsxs)("div",{className:(0,a.A)(s.G.tabs.container,"tabs-container",b.tabList),children:[(0,k.jsx)(f,{...n,...e}),(0,k.jsx)(A,{...n,...e})]})}function y(e){const n=(0,x.A)();return(0,k.jsx)(C,{...e,children:h(e.children)},String(n))}},19365:(e,n,r)=>{r.d(n,{A:()=>i});r(96540);var t=r(34164);const a={tabItem:"tabItem_Ymn6"};var s=r(74848);function i({children:e,hidden:n,className:r}){return(0,s.jsx)("div",{role:"tabpanel",className:(0,t.A)(a.tabItem,r),hidden:n,children:e})}},28453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>o});var t=r(96540);const a={},s=t.createContext(a);function i(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),t.createElement(s.Provider,{value:n},e.children)}},28887:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/argo-cd-project-copy-token-69fb0d7de399ac0450fc6a81a387cd0c.png"},34232:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/argo-cd-open-settings-7d49a6e5d5b74bf3998b1b28857be772.png"},35535:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/argo-cd-project-select-role-fbc8786f770332568830c6d30084e247.png"},41143:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/argo-cd-project-krci-e2f86c8c696fcba6bd736043cda54b79.png"},43470:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/argo-cd-integration-portal-47e4ed4ba37e1dbbd6001befd95313e8.png"},48463:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/argo-cd-project-roles-tab-a93cc7864318e079955c7cdeb270e9e6.png"},61351:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>c,metadata:()=>t,toc:()=>p});const t=JSON.parse('{"id":"operator-guide/cd/argocd-integration","title":"Argo CD Integration","description":"Guide on integrating Argo CD with KubeRocketCI for GitOps-based deployments, including setup instructions for Keycloak OIDC authentication.","source":"@site/docs/operator-guide/cd/argocd-integration.md","sourceDirName":"operator-guide/cd","slug":"/operator-guide/cd/argocd-integration","permalink":"/docs/next/operator-guide/cd/argocd-integration","draft":false,"unlisted":false,"editUrl":"https://github.com/KubeRocketCI/docs/edit/main/docs/operator-guide/cd/argocd-integration.md","tags":[],"version":"current","lastUpdatedBy":"Oleksandr_Stepanov@epam.com","lastUpdatedAt":1754920776000,"frontMatter":{"title":"Argo CD Integration","description":"Guide on integrating Argo CD with KubeRocketCI for GitOps-based deployments, including setup instructions for Keycloak OIDC authentication.","sidebar_label":"Argo CD Integration"},"sidebar":"operatorGuideSidebar","previous":{"title":"Deploy Application In Remote Cluster via Token","permalink":"/docs/next/operator-guide/cd/deploy-application-in-remote-cluster-via-token"},"next":{"title":"Overview","permalink":"/docs/next/operator-guide/infrastructure-providers/overview"}}');var a=r(74848),s=r(28453),i=r(11470),o=r(19365);const c={title:"Argo CD Integration",description:"Guide on integrating Argo CD with KubeRocketCI for GitOps-based deployments, including setup instructions for Keycloak OIDC authentication.",sidebar_label:"Argo CD Integration"},l="Argo CD Integration",d={},p=[{value:"Argo CD Deployment Approach in KubeRocketCI",id:"argo-cd-deployment-approach-in-kuberocketci",level:2},{value:"Integration",id:"integration",level:2},{value:"Argo CD Configuration",id:"argo-cd-configuration",level:2},{value:"Check Argo CD Integration (Optional)",id:"check-argo-cd-integration-optional",level:2},{value:"Deploy Argo CD Application to Remote Cluster (Optional)",id:"deploy-argo-cd-application-to-remote-cluster-optional",level:2},{value:"Keycloak Integration (Optional)",id:"keycloak-integration-optional",level:2},{value:"Related Articles",id:"related-articles",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components},{Details:t,Head:c}=n;return t||g("Details",!0),c||g("Head",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"argo-cd-integration",children:"Argo CD Integration"})}),"\n",(0,a.jsx)(c,{children:(0,a.jsx)("link",{rel:"canonical",href:"https://docs.kuberocketci.io/docs/operator-guide/cd/argocd-integration"})}),"\n",(0,a.jsxs)(n.p,{children:["KubeRocketCI uses Argo CD as a ",(0,a.jsx)(n.a,{href:"/docs/next/user-guide/cd-pipeline-details",children:"part of the Continuous Delivery/Continuous Deployment"}),"\nimplementation. Argo CD follows the best GitOps practices, uses Kubernetes native approach for the Deployment Management, has rich UI and\nrequired RBAC capabilities."]}),"\n",(0,a.jsx)(n.h2,{id:"argo-cd-deployment-approach-in-kuberocketci",children:"Argo CD Deployment Approach in KubeRocketCI"}),"\n",(0,a.jsxs)(n.p,{children:["Argo CD can be installed using ",(0,a.jsx)(n.a,{href:"https://argo-cd.readthedocs.io/en/stable/operator-manual/installation",children:"two different approaches"}),":"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Cluster-wide scope with the cluster-admin access"}),"\n",(0,a.jsx)(n.li,{children:"Namespaced scope with the single namespace access"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Both approaches can be deployed with High Availability (HA) or Non High Availability (non HA) installation manifests."}),"\n",(0,a.jsxs)(n.p,{children:["KubeRocketCI uses the HA deployment with the cluster-admin permissions, to minimize cluster resources consumption by sharing\nsingle Argo CD instance across multiple KubeRocketCI Tenants. Please follow ",(0,a.jsx)(n.a,{href:"/docs/next/operator-guide/install-argocd",children:"the installation instructions"})," to deploy Argo CD."]}),"\n",(0,a.jsx)(n.h2,{id:"integration",children:"Integration"}),"\n",(0,a.jsx)(n.p,{children:"See a diagram below for the details:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"edp-argocd",src:r(70552).A+"",title:"Argo CD Diagram",width:"925",height:"691"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Argo CD is deployed in a separate ",(0,a.jsx)(n.code,{children:"argocd"})," namespace."]}),"\n",(0,a.jsxs)(n.li,{children:["Argo CD uses a ",(0,a.jsx)(n.code,{children:"cluster-admin"})," role for managing cluster-scope resources."]}),"\n",(0,a.jsxs)(n.li,{children:["The ",(0,a.jsx)(n.code,{children:"control-plane"})," application is created using the App of Apps approach, and its code is managed by the ",(0,a.jsx)(n.code,{children:"control-plane"})," members."]}),"\n",(0,a.jsxs)(n.li,{children:["The ",(0,a.jsx)(n.code,{children:"control-plane"})," is used to onboard new Argo CD Tenants (Argo CD Projects - AppProject)."]}),"\n",(0,a.jsxs)(n.li,{children:["The ",(0,a.jsx)(n.code,{children:"KubeRocketCI Tenant Member"})," manages ",(0,a.jsx)(n.code,{children:"Argo CD Applications"})," using ",(0,a.jsx)(n.code,{children:"kind: Application"})," in the ",(0,a.jsx)(n.code,{children:"krciTenant"})," namespace."]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.a,{href:"https://argo-cd.readthedocs.io/en/stable/operator-manual/cluster-bootstrapping/",children:"App Of Apps approach"})," is used to\nmanage the ",(0,a.jsx)(n.code,{children:"KubeRocketCI Tenants"}),". Inspect the ",(0,a.jsx)(n.a,{href:"https://github.com/SergK/edp-grub",children:"edp-grub"})," repository structure that is used to\nprovide the KubeRocketCI Tenants for the Argo CD Projects:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"edp-grub\n\u251c\u2500\u2500 LICENSE\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 apps                      ### All Argo CD Applications are stored here\n\u2502\xa0\xa0 \u251c\u2500\u2500 grub-argocd.yaml      # Application that provisions Argo CD Resources - Argo Projects (KubeRocketCI Tenants)\n\u2502\xa0\xa0 \u2514\u2500\u2500 grub-keycloak.yaml    # Application that provisions Keycloak Resources - Argo CD Groups (KubeRocketCI Tenants)\n\u251c\u2500\u2500 apps-configs\n\u2502\xa0\xa0 \u2514\u2500\u2500 grub\n\u2502\xa0\xa0     \u251c\u2500\u2500 argocd            ### Argo CD resources definition\n\u2502\xa0\xa0     \u2502\xa0\xa0 \u2514\u2500\u2500 edp.yaml\n\u2502\xa0\xa0     \u2514\u2500\u2500 keycloak          ### Keycloak resources definition\n\u2502\xa0\xa0         \u2514\u2500\u2500 edp.yaml\n\u251c\u2500\u2500 bootstrap\n\u2502\xa0\xa0 \u2514\u2500\u2500 root.yaml             ### Root application in App of Apps, which provision Applications from /apps\n\u2514\u2500\u2500 examples                  ### Examples\n    \u2514\u2500\u2500 tenant\n        \u2514\u2500\u2500 edp-petclinic.yaml\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The Root Application must be created under the ",(0,a.jsx)(n.code,{children:"control-plane"})," scope."]}),"\n",(0,a.jsx)(n.h2,{id:"argo-cd-configuration",children:"Argo CD Configuration"}),"\n",(0,a.jsx)(n.p,{children:"Now that Argo CD is integrated, it is time to configure it properly. To configure Argo CD for KubeRocketCI, follow the steps below:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Modify the ",(0,a.jsx)(n.code,{children:"argocd-cmd-params-cm"})," ConfigMap in the ",(0,a.jsx)(n.code,{children:"argocd"})," namespace and add the ",(0,a.jsx)(n.code,{children:"application.namespaces"})," parameter to the ",(0,a.jsx)(n.code,{children:"data"})," subsection:"]}),"\n",(0,a.jsxs)(i.A,{defaultValue:"kubectl",values:[{label:"kubectl",value:"kubectl"},{label:"manifest",value:"manifest"}],children:[(0,a.jsx)(o.A,{value:"kubectl",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'kubectl patch configmap argocd-cmd-params-cm -n argocd --type merge -p \'{"data":{"application.namespaces":"krci"}}\'\n'})})}),(0,a.jsx)(o.A,{value:"manifest",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"data:\n  application.namespaces: krci\n"})})})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Add a ",(0,a.jsx)(n.a,{href:"https://argo-cd.readthedocs.io/en/stable/user-guide/private-repositories/#private-repositories",children:"credential template"}),"\nfor GitHub, GitLab, Bitbucket, or Gerrit integrations. The credential template must be created for each Git Server."]}),"\n",(0,a.jsxs)(i.A,{defaultValue:"github",values:[{label:"GitHub/GitLab/Bitbucket",value:"github"},{label:"Gerrit",value:"gerrit"}],children:[(0,a.jsxs)(o.A,{value:"github",children:[(0,a.jsx)(n.p,{children:"Generate an SSH key pair and add a public key to GitLab, GitHub, or Bitbucket account."}),(0,a.jsxs)(n.admonition,{type:"warning",children:[(0,a.jsxs)(n.p,{children:["Use an additional GitHub/GitLab User to access a repository. For example:",(0,a.jsx)("br",{})]}),(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:['GitHub, add a User to a repository with a "Read" role.',(0,a.jsx)("br",{})]}),"\n",(0,a.jsx)(n.li,{children:'GitLab, add a User to a repository with a "Guest" role.'}),"\n"]})]}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'ssh-keygen -t ed25519 -C "email@example.com" -f argocd\n'})}),(0,a.jsx)(n.p,{children:"Copy SSH private key to Argo CD namespace."}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'KRCI_NAMESPACE="krci"\nVCS_HOST="<github.com_or_gitlab.com_or_bitbucket.org>"\nACCOUNT_NAME="<ACCOUNT_NAME>"\nURL="ssh://git@${VCS_HOST}:22/${ACCOUNT_NAME}"\n\nkubectl create secret generic ${KRCI_NAMESPACE} -n argocd \\\n  --from-file=sshPrivateKey=argocd \\\n  --from-literal=url="${URL}"\nkubectl label --overwrite secret ${KRCI_NAMESPACE} -n argocd "argocd.argoproj.io/secret-type=repo-creds"\n'})})]}),(0,a.jsxs)(o.A,{value:"gerrit",children:[(0,a.jsx)(n.p,{children:"Copy existing SSH private key for Gerrit to Argo CD namespace."}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'KRCI_NAMESPACE="krci"\nGERRIT_PORT=$(kubectl get gerrit gerrit -n ${KRCI_NAMESPACE} -o jsonpath=\'{.spec.sshPort}\')\nGERRIT_ARGOCD_SSH_KEY_NAME="gerrit-ciuser-sshkey"\nGERRIT_URL=$(echo "ssh://edp-ci@gerrit.${KRCI_NAMESPACE}:${GERRIT_PORT}" | base64)\nkubectl get secret ${GERRIT_ARGOCD_SSH_KEY_NAME} -n ${KRCI_NAMESPACE} -o json | jq \'del(.data.username,.metadata.annotations,.metadata.creationTimestamp,.metadata.labels,.metadata.resourceVersion,.metadata.uid,.metadata.ownerReferences)\' | jq \'.metadata.namespace = "argocd"\' | jq --arg name "${KRCI_NAMESPACE}" \'.metadata.name = $name\' | jq --arg url "${GERRIT_URL}" \'.data.url = $url\' | jq \'.data.sshPrivateKey = .data.id_rsa\' | jq \'del(.data.id_rsa,.data."id_rsa.pub")\' | kubectl apply -f -\nkubectl label --overwrite secret ${KRCI_NAMESPACE} -n argocd "argocd.argoproj.io/secret-type=repo-creds"\n'})})]})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Add ",(0,a.jsx)(n.a,{href:"https://argo-cd.readthedocs.io/en/stable/user-guide/private-repositories/#unknown-ssh-hosts",children:"SSH Known hosts"}),"\nfor GitHub, GitLab, Bitbucket, or Gerrit integration."]}),"\n",(0,a.jsxs)(i.A,{defaultValue:"github",values:[{label:"GitHub/GitLab/Bitbucket",value:"github"},{label:"Gerrit",value:"gerrit"}],children:[(0,a.jsxs)(o.A,{value:"github",children:[(0,a.jsx)(n.p,{children:"Add GitHub, GitLab, or Bitbucket host to Argo CD config map with known hosts."}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'KRCI_NAMESPACE="krci"\nVCS_HOST="<VCS_HOST>"\nKNOWN_HOSTS_FILE="/tmp/ssh_known_hosts"\nARGOCD_KNOWN_HOSTS_NAME="argocd-ssh-known-hosts-cm"\n\nrm -f ${KNOWN_HOSTS_FILE}\nkubectl get cm ${ARGOCD_KNOWN_HOSTS_NAME} -n argocd -o jsonpath=\'{.data.ssh_known_hosts}\' > ${KNOWN_HOSTS_FILE}\nssh-keyscan ${VCS_HOST} >> ${KNOWN_HOSTS_FILE}\nkubectl create configmap ${ARGOCD_KNOWN_HOSTS_NAME} -n argocd --from-file ${KNOWN_HOSTS_FILE} -o yaml --dry-run=client | kubectl apply -f -\n'})})]}),(0,a.jsxs)(o.A,{value:"gerrit",children:[(0,a.jsx)(n.p,{children:"Add Gerrit host to Argo CD config map with known hosts"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'KRCI_NAMESPACE="krci"\nKNOWN_HOSTS_FILE="/tmp/ssh_known_hosts"\nARGOCD_KNOWN_HOSTS_NAME="argocd-ssh-known-hosts-cm"\nGERRIT_PORT=$(kubectl get gerrit gerrit -n ${KRCI_NAMESPACE} -o jsonpath=\'{.spec.sshPort}\')\n\nrm -f ${KNOWN_HOSTS_FILE}\nkubectl get cm ${ARGOCD_KNOWN_HOSTS_NAME} -n argocd -o jsonpath=\'{.data.ssh_known_hosts}\' > ${KNOWN_HOSTS_FILE}\nkubectl exec -it deployment/gerrit -n ${KRCI_NAMESPACE} -- ssh-keyscan -p ${GERRIT_PORT} gerrit.${KRCI_NAMESPACE} >> ${KNOWN_HOSTS_FILE}\nkubectl create configmap ${ARGOCD_KNOWN_HOSTS_NAME} -n argocd --from-file ${KNOWN_HOSTS_FILE} -o yaml --dry-run=client | kubectl apply -f -\n'})})]})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Create an Argo CD Project (Tenant), for example, with the ",(0,a.jsx)(n.code,{children:"krci"})," name:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="AppProject"',children:"apiVersion: argoproj.io/v1alpha1\nkind: AppProject\nmetadata:\n  name: krci\n  namespace: argocd\n  # Finalizer that ensures that project is not deleted until it is not referenced by any application\n  finalizers:\n    - resources-finalizer.argocd.argoproj.io\nspec:\n  destinations:\n    # by default krci work with 'krci-*' namespace\n    - namespace: 'krci-*'\n    # allow to deploy to specific server (local in our case)\n      name: in-cluster\n  # Deny all cluster-scoped resources from being created, except for Namespace\n  clusterResourceWhitelist:\n  - group: ''\n    kind: Namespace\n  # Allow all namespaced-scoped resources to be created, except for ResourceQuota, LimitRange, NetworkPolicy\n  namespaceResourceBlacklist:\n  - group: ''\n    kind: ResourceQuota\n  - group: ''\n    kind: LimitRange\n  - group: ''\n    kind: NetworkPolicy\n  # we are ok to create any resources inside namespace\n  namespaceResourceWhitelist:\n  - group: '*'\n    kind: '*'\n  # enable access only for specific git server. The example below 'krci' - it is namespace where KubeRocketCI deployed\n  sourceRepos:\n    - ssh://git@github.com/*\n  # enable capability to deploy objects from namespaces\n  sourceNamespaces:\n    - krci\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Check that your new ",(0,a.jsx)(n.strong,{children:"Repository"}),", ",(0,a.jsx)(n.strong,{children:"Known Hosts"}),", and ",(0,a.jsx)(n.strong,{children:"AppProject"})," are added to the Argo CD UI."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Generate Argo CD project token for deploy integration:"}),"\n",(0,a.jsxs)(i.A,{defaultValue:"yaml",values:[{label:"YAML",value:"yaml"},{label:"UI",value:"ui"}],children:[(0,a.jsx)(o.A,{value:"yaml",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'URL=<ARGO CD URL>\nTOKEN=$(argocd proj role create-token krci developer -i argocd-ci -t)\n\n\ncat <<EOF | kubectl apply -f -\napiVersion: v1\nkind: Secret\nmetadata:\n  name: argocd-ci\n  namespace: krci\n  labels:\n    app.edp.epam.com/integration-secret: "true"\n    app.edp.epam.com/secret-type: "argocd"\ntype: Opaque\nstringData:\n  token: $TOKEN\n  url: $URL\nEOF\n'})})}),(0,a.jsxs)(o.A,{value:"ui",children:[(0,a.jsx)(n.p,{children:"Generate Argo CD project token via UI, follow the steps below:"}),(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Open your Argo CD endpoint."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["In the Argo CD main menu, select ",(0,a.jsx)(n.strong,{children:"Settings"}),":"]}),"\n"]}),"\n"]}),(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Argo CD settings",src:r(34232).A+"",title:"Argo CD settings",width:"1922",height:"994"})}),(0,a.jsxs)(n.ol,{start:"3",children:["\n",(0,a.jsxs)(n.li,{children:["On the ",(0,a.jsx)(n.strong,{children:"Settings"})," page, select ",(0,a.jsx)(n.strong,{children:"Projects"}),":"]}),"\n"]}),(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Argo CD projects",src:r(77657).A+"",title:"Argo CD projects",width:"1922",height:"994"})}),(0,a.jsxs)(n.ol,{start:"4",children:["\n",(0,a.jsxs)(n.li,{children:["On the ",(0,a.jsx)(n.strong,{children:"Projects"})," page, select the previously created Argo CD project:"]}),"\n"]}),(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Select krci project",src:r(41143).A+"",title:"Select krci project",width:"1922",height:"994"})}),(0,a.jsxs)(n.ol,{start:"5",children:["\n",(0,a.jsxs)(n.li,{children:["On the project details page, select the ",(0,a.jsx)(n.strong,{children:"Roles"})," tab:"]}),"\n"]}),(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Roles tab",src:r(48463).A+"",title:"Roles tab",width:"1922",height:"994"})}),(0,a.jsxs)(n.ol,{start:"6",children:["\n",(0,a.jsxs)(n.li,{children:["On the ",(0,a.jsx)(n.strong,{children:"Roles"})," tab, select the ",(0,a.jsx)(n.strong,{children:"developer"})," role:"]}),"\n"]}),(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Developer role",src:r(35535).A+"",title:"Developer role",width:"1922",height:"994"})}),(0,a.jsxs)(n.ol,{start:"7",children:["\n",(0,a.jsxs)(n.li,{children:["On the appeared window, scroll down to the ",(0,a.jsx)(n.strong,{children:"JWT Tokens"})," section, specify the required fields and click ",(0,a.jsx)(n.strong,{children:"Create"}),":"]}),"\n"]}),(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Token ID"}),": Token name."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Expires in"}),': Defines the period for which the token is considered valid. Must be in the "[0-9]+[s,m,h,d]" format. For example, "12h", "7d".']}),"\n"]}),(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Create JWT token",src:r(7328).A+"",title:"Create JWT token",width:"1922",height:"994"})}),(0,a.jsxs)(n.ol,{start:"8",children:["\n",(0,a.jsx)(n.li,{children:"Confirm the token creation:"}),"\n"]}),(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Confirm token creation",src:r(8612).A+"",title:"Confirm token creation",width:"1922",height:"994"})}),(0,a.jsxs)(n.ol,{start:"9",children:["\n",(0,a.jsx)(n.li,{children:"Copy the data of the newly created token:"}),"\n"]}),(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Copy token data",src:r(28887).A+"",title:"Copy token data",width:"1922",height:"994"})}),(0,a.jsxs)(n.ol,{start:"10",children:["\n",(0,a.jsxs)(n.li,{children:["Navigate to ",(0,a.jsx)(n.strong,{children:"KubeRocketCI portal"})," -> ",(0,a.jsx)(n.strong,{children:"Configuration"})," -> ",(0,a.jsx)(n.strong,{children:"Deployment"})," -> ",(0,a.jsx)(n.strong,{children:"Argo CD"})," and click ",(0,a.jsx)(n.strong,{children:"+ Add integration"}),":"]}),"\n"]}),(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Argo CD configuration page",src:r(43470).A+"",title:"Argo CD configuration page",width:"1922",height:"994"})}),(0,a.jsxs)(n.ol,{start:"11",children:["\n",(0,a.jsxs)(n.li,{children:["In the integration window, specify the required fields and click ",(0,a.jsx)(n.strong,{children:"Save"}),":"]}),"\n"]}),(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Quick Link URL"}),": Enter the URL of your Argo CD instance (e.g., ",(0,a.jsx)(n.a,{href:"https://argocd.example.com",children:"https://argocd.example.com"}),"). A quick link will be added to the Overview section for quick access to Argo CD from the KubeRocketCI portal."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"URL"}),":  Enter the URL of your Argo CD instance (e.g., ",(0,a.jsx)(n.a,{href:"https://argocd.example.com",children:"https://argocd.example.com"}),")."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Token"}),": Paste the JWT token data copied earlier."]}),"\n"]}),(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Specify required fields",src:r(75341).A+"",title:"Specify required fields",width:"1924",height:"996"})}),(0,a.jsxs)(n.ol,{start:"12",children:["\n",(0,a.jsx)(n.li,{children:"Verify that the integration status is green:"}),"\n"]}),(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Verify integration status",src:r(95048).A+"",title:"Verify integration status",width:"1922",height:"994"})})]})]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Once Argo CD is successfully integrated, KubeRocketCI user can utilize Argo CD to deploy ",(0,a.jsx)(n.a,{href:"/docs/next/user-guide/add-cd-pipeline",children:"CD pipelines"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"check-argo-cd-integration-optional",children:"Check Argo CD Integration (Optional)"}),"\n",(0,a.jsx)(n.p,{children:"This section provides the information on how to test the integration with Argo CD and is not mandatory to be followed."}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Add an Argo CD application:"}),"\n",(0,a.jsxs)(t,{children:[(0,a.jsx)("summary",{children:(0,a.jsx)("b",{children:"View: argocd-values.yaml"})}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: demo\nspec:\n  project: krci\n  destination:\n    namespace: krci-demo\n    server: https://kubernetes.default.svc\n  source:\n    helm:\n      parameters:\n        - name: image.tag\n          value: master-0.1.0-1\n        - name: image.repository\n          value: image-repo\n    path: deploy-templates\n    # github/gitlab example ssh://git@github.com/<github_account_name>/<repository_name>.git\n    # gerrit example ssh://<gerrit_user>@gerrit.krci:30007/<repository_name>.git\n    repoURL: ssh://git@github.com/krci/demo.git\n    targetRevision: master\n  syncPolicy:\n    syncOptions:\n      - CreateNamespace=true\n    automated:\n      selfHeal: true\n      prune: true\n"})})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Check that your new Application is added to the Argo CD UI under the ",(0,a.jsx)(n.code,{children:"krci"})," Project scope."]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"deploy-argo-cd-application-to-remote-cluster-optional",children:"Deploy Argo CD Application to Remote Cluster (Optional)"}),"\n",(0,a.jsx)(n.p,{children:"KubeRocketCI also supports deploying Argo CD applications to a remote cluster. To deploy applications to remote clusters, follow the steps below:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Create ",(0,a.jsx)(n.code,{children:"ServiceAccount"})," ",(0,a.jsx)(n.code,{children:"ClusterRoleBinding"})," and ",(0,a.jsx)(n.code,{children:"Secret"})," for that ",(0,a.jsx)(n.code,{children:"ServiceAccount"}),"."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Receive the bearer token:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"BEAR_TOKEN=$(kubectl get secret <serviceaccount-secret-name> -o jsonpath='{.data.token}' | base64 --decode)\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Create ArgoCD secret for remote cluster:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="manifest"',children:'apiVersion: v1\nkind: Secret\nmetadata:\n  name: krci-remote-cluster\n  namespace: argocd\ndata:\n  # Remote cluster config\n  config: {"bearerToken":"<BEAR_TOKEN>","tlsClientConfig":{"insecure":false,"caData":"<certificate-authority-data>"}}\n  # Remote cluster name\n  name: "krci-remote-cluster"\n  # Cluster endpoint URL\n  server: "https://xxxxxxxxxxxxxxxxxxxx.sk1.eu-central-1.eks.amazonaws.com"\ntype: stringData\n'})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Update an Argo CD Project (KubeRocketCI Tenant), with the ",(0,a.jsx)(n.code,{children:"krci"})," name:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="AppProject"',children:"apiVersion: argoproj.io/v1alpha1\nkind: AppProject\nmetadata:\n  name: krci\nspec:\n  destinations:\n      # Add block that allow deploy in remote cluster\n      # by default, krci works with 'krci-*' namespaces\n    - namespace: 'krci-*'\n      # allow to deploy to specific server (remote in our case)\n      name: krci-remote-cluster\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Add a remote cluster in the KubeRocketCI portal. Please refer to the ",(0,a.jsx)(n.a,{href:"/docs/next/user-guide/add-cluster",children:"Add Cluster"})," page for details."]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"keycloak-integration-optional",children:"Keycloak Integration (Optional)"}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsxs)(n.p,{children:["To proceed with the steps below, you need the ",(0,a.jsx)(n.a,{href:"https://github.com/epam/edp-keycloak-operator",children:"edp-keycloak-operator"})," to be deployed."]})}),"\n",(0,a.jsx)(n.p,{children:"To provide Argo CD with the Keycloak SSO authorization mechanism, follow the guidelines below:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Create secret ",(0,a.jsx)(n.code,{children:"keycloak-client-argocd-secret"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl create secret generic keycloak-client-argocd-secret \\\n--from-literal=clientSecret=$(openssl rand -base64 32) \\\n--namespace=argocd\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Update the ",(0,a.jsx)(n.code,{children:"argocd-cm"})," ConfigMap:"]}),"\n",(0,a.jsxs)(i.A,{defaultValue:"kubectl",values:[{label:"kubectl",value:"kubectl"},{label:"manifest",value:"manifest"}],children:[(0,a.jsx)(o.A,{value:"kubectl",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'kubectl patch configmap argocd-cm -n argocd --patch "$(cat <<EOF\ndata:\n  oidc.config: |\n    name: Keycloak\n    issuer: https://<keycloakEndpoint>/auth/realms/edp\n    clientID: argocd-tenant\n    clientSecret: $keycloak-client-argocd-secret:clientSecret\n    requestedScopes:\n      - openid\n      - profile\n      - email\n      - groups\nEOF\n)"\n'})})}),(0,a.jsx)(o.A,{value:"manifest",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'data:\n  oidc.config:\n    url: "https://argocd.<.Values.global.dnsWildCard>"\n    application.instanceLabelKey: argocd.argoproj.io/instance-edp\n    oidc.config: |\n      name: Keycloak\n      issuer: https://<.Values.global.keycloakEndpoint>/auth/realms/edp\n      clientID: argocd-tenant\n      clientSecret: $keycloak-client-argocd-secret:clientSecret\n      requestedScopes:\n        - openid\n        - profile\n        - email\n        - groups\n'})})})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Create a Keycloak Group:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1.edp.epam.com/v1\nkind: KeycloakRealmGroup\nmetadata:\n  name: argocd-krci-users\nspec:\n  name: ArgoCD-krci-users\n  realm: main\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Create a Keycloak Client:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1.edp.epam.com/v1\nkind: KeycloakClient\nmetadata:\n  name: argocd\n  namespace: argocd\nspec:\n  advancedProtocolMappers: true\n  attributes:\n    post.logout.redirect.uris: +\n  clientId: argocd-tenant\n  defaultClientScopes:\n    - groups\n  realmRef:\n    kind: ClusterKeycloakRealm\n    name: main\n  secret: keycloak-client-argocd-secret\n  webUrl: "https://argocd.<.Values.global.dnsWildCard>"\n'})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["In Keycloak, add users to the ",(0,a.jsx)(n.code,{children:"ArgoCD-krci-users"})," Keycloak Group."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Update spec in project:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="AppProject"',children:"spec:\n  description: CD pipelines for krci\n  roles:\n    - name: developer\n      description: Users for krci tenant\n      policies:\n        - p, proj:krci:developer, applications, create, krci/*, allow\n        - p, proj:krci:developer, applications, delete, krci/*, allow\n        - p, proj:krci:developer, applications, get, krci/*, allow\n        - p, proj:krci:developer, applications, override, krci/*, allow\n        - p, proj:krci:developer, applications, sync, krci/*, allow\n        - p, proj:krci:developer, applications, update, krci/*, allow\n        - p, proj:krci:developer, repositories, create, krci/*, allow\n        - p, proj:krci:developer, repositories, delete, krci/*, allow\n        - p, proj:krci:developer, repositories, update, krci/*, allow\n        - p, proj:krci:developer, repositories, get, krci/*, allow\n      groups:\n        # Keycloak Group name\n        - ArgoCD-krci-users\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Then restart the deployment:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl -n argocd rollout restart deployment argo-argocd-server\n"})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"related-articles",children:"Related Articles"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/docs/next/operator-guide/install-argocd",children:"Install Argo CD"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}function g(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},70552:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/edp-argocd-910f2968a3ffd0c29cfb620352db38ae.png"},75341:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/argo-cd-project-integration-portal-23bcb55ae3fd59228e1b54c793453bba.png"},77657:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/argo-cd-open-projects-e3d5dbb3027990f2394412012825cddf.png"},95048:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/argo-cd-project-token-added-7df84e3f2bc3070a3779ff997bb20edd.png"}}]);