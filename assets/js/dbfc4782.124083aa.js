"use strict";(self.webpackChunkkuberocketci_docs=self.webpackChunkkuberocketci_docs||[]).push([[38749],{91895:e=>{e.exports=JSON.parse('{"archive":{"blogPosts":[{"id":"integrating-oidc-authentication-microsoft-entra-aws-eks","metadata":{"permalink":"/blog/integrating-oidc-authentication-microsoft-entra-aws-eks","source":"@site/blog/2024-12-03/aws-eks-microsoft-entra-oidc-integration.md","title":"Integrating OIDC Authentication with Microsoft Entra in AWS EKS","description":"Learn how to implement Single Sign-On (SSO) using OpenID Connect (OIDC) and Microsoft Entra to enhance security and streamline authentication processes in Amazon Elastic Kubernetes Service (AWS EKS).","date":"2024-12-03T00:00:00.000Z","tags":[{"inline":true,"label":"KubeRocketCI","permalink":"/blog/tags/kube-rocket-ci"},{"inline":true,"label":"AWS EKS","permalink":"/blog/tags/aws-eks"},{"inline":true,"label":"SSO","permalink":"/blog/tags/sso"},{"inline":true,"label":"Microsoft Entra","permalink":"/blog/tags/microsoft-entra"},{"inline":true,"label":"OIDC","permalink":"/blog/tags/oidc"},{"inline":true,"label":"Kubernetes","permalink":"/blog/tags/kubernetes"},{"inline":true,"label":"Security","permalink":"/blog/tags/security"}],"readingTime":12.21,"hasTruncateMarker":true,"authors":[{"name":"Daniil Nedostup","title":"Systems Engineer","url":"https://github.com/daniil-nedostup","page":{"permalink":"/blog/authors/daniilnedostup"},"socials":{"linkedin":"https://www.linkedin.com/in/daniil-nedostup/","github":"https://github.com/daniil-nedostup"},"imageURL":"https://github.com/daniil-nedostup.png","key":"daniilnedostup"}],"frontMatter":{"title":"Integrating OIDC Authentication with Microsoft Entra in AWS EKS","description":"Learn how to implement Single Sign-On (SSO) using OpenID Connect (OIDC) and Microsoft Entra to enhance security and streamline authentication processes in Amazon Elastic Kubernetes Service (AWS EKS).","slug":"integrating-oidc-authentication-microsoft-entra-aws-eks","tags":["KubeRocketCI","AWS EKS","SSO","Microsoft Entra","OIDC","Kubernetes","Security"],"keywords":["KubeRocketCI","Microsoft Entra","AWS EKS","Kubernetes","AWS","EKS","IAM","OpenID Connect","Single Sign-On","Security","Authentication","Authorization"],"image":"https://i.imgur.com/mErPwqL.png","authors":["daniilnedostup"],"hide_table_of_contents":false},"unlisted":false,"nextItem":{"title":"Advanced AWS EKS Management: Implementing SSO via OIDC and Keycloak","permalink":"/blog/advanced-aws-eks-management-oidc-keycloak"}},"content":"In modern cloud environments, secure and efficient access management is essential, especially for platforms like Amazon EKS. This blog will guide you through integrating OpenID Connect (OIDC) authentication using Microsoft Entra, making it easier to manage access to your EKS clusters and KubeRocketCI Portal. By implementing this approach, you can simplify user authentication while ensuring strong security controls. Whether you\'re improving compliance or streamlining access for your team, this integration is a practical solution to enhance your cloud-native workflows.\\n\\n\x3c!--truncate--\x3e\\n\\n## Prerequisites\\n\\nBefore you begin, ensure you have the following:\\n\\n- Access to the [Microsoft Entra Admin Center](https://entra.microsoft.com/?feature.msaljs=true#home) with administrative privileges.\\n- A running [AWS EKS](https://docs.aws.amazon.com/eks/latest/userguide/create-cluster.html) cluster with the necessary permissions for access and management.\\n- The [kubelogin](https://github.com/int128/kubelogin) plugin installed for authenticating to the EKS cluster using OIDC.\\n- The [kubectl](https://kubernetes.io/docs/tasks/tools/#kubectl) CLI tool installed.\\n- The [aws cli](https://aws.amazon.com/cli/) tool installed.\\n\\n## Understanding SSO, OIDC, and Microsoft Entra\\n\\nIn the context of enhancing digital security and user experience, we prioritize the integration of three key elements: Single Sign-On (SSO), OpenID Connect (OIDC), and Microsoft Entra. Here\u2019s how they connect:\\n\\n- **Single Sign-On (SSO)** serves as the foundation, enabling users to access multiple applications with one set of login credentials, significantly simplifying the authentication process.\\n\\n- **OpenID Connect (OIDC)** builds on the SSO framework by providing an authentication layer, which uses straightforward identity verification to ensure secure and seamless access across services.\\n\\n- **Microsoft Entra** (formerly known as **Azure Active Directory**) is Microsoft\'s comprehensive identity and access management solution. It supports the implementation of both Single Sign-On (SSO) and OpenID Connect (OIDC), enabling organizations to securely manage user identities and enforce access controls. With its reliable set of tools, Microsoft Entra simplifies authentication, enhances security, and ensures seamless access to applications and services, making it an essential platform for modern identity management.\\n\\nTogether, these technologies streamline the login process, reinforce security, and enhance the user experience by allowing secure, seamless navigation across our digital ecosystem.\\n\\n### Microsoft Entra Overview\\n\\nMicrosoft Entra, formerly known as Azure Active Directory (Azure AD), is a modern identity and access management solution designed for secure access to applications and services. It provides features like Single Sign-On (SSO), identity federation, and seamless integration with on-premises directories such as LDAP and Active Directory. Microsoft Entra supports industry-standard protocols, including OpenID Connect (OIDC), OAuth 2.0, and Security Assertion Markup Language (SAML) 2.0, making it a versatile solution for managing user identities. By leveraging Microsoft Entra, organizations can enhance security, simplify user access, and avoid the complexities of building identity management features from scratch. For more details, see the [Microsoft Entra official documentation](https://learn.microsoft.com/en-gb/entra/identity).\\n\\n## Create a new Microsoft Entra Tenant\\n\\nTo get started with Microsoft Entra, you need to create a new tenant in the Microsoft Entra Admin Center. Follow these steps:\\n\\n1. Log in to the [Microsoft Entra Admin Center](https://entra.microsoft.com/?feature.msaljs=true#home) using your Microsoft account.\\n\\n    ![Microsoft Entra Admin Center](../assets/aws-eks-microsoft-entra-oidc-integration/microsoft-entra-admin-center.png)\\n\\n2. In the left sidebar menu, select **Overview** section and then navigate to **Manage tenants** tab.\\n\\n    ![Manage Tenants](../assets/aws-eks-microsoft-entra-oidc-integration/manage-tenants.png)\\n\\n3. Click on **Create** button to create a new tenant.\\n\\n    ![Create Tenant](../assets/aws-eks-microsoft-entra-oidc-integration/create-tenant.png)\\n\\n4. Select the configuration type **Workforce**.\\n\\n    ![Configuration Type](../assets/aws-eks-microsoft-entra-oidc-integration/configuration-type.png)\\n\\n5. Fill in the fields for **Tenant Name**, **Domain Name**, and **Location**.\\n\\n    :::note\\n    The **Tenant Name** and **Domain Name** `kuberocketci` are used as a demonstration examples. In your case, it is recommended to choose names that align with your organization\'s specific needs and naming conventions.\\n    :::\\n\\n    ![Tenant Details](../assets/aws-eks-microsoft-entra-oidc-integration/tenant-details.png)\\n\\n6. The new tenant will be created, and you can start configuring it for OIDC integration. Ensure you have switched to the new tenant.\\n\\n## Creating and Configuring OIDC Application in Microsoft Entra\\n\\nAfter creating the tenant, you need to set up an OIDC Application in Microsoft Entra. Here\'s how you can do it:\\n\\n1. In the Microsoft Entra Admin Center, in the left sidebar menu, select **Applications** and then click on **App registrations**.\\n\\n    ![App Registrations](../assets/aws-eks-microsoft-entra-oidc-integration/app-registrations.png)\\n\\n2. Click on the **New registration** button to create a new application.\\n\\n    ![New Registration](../assets/aws-eks-microsoft-entra-oidc-integration/new-registration.png)\\n\\n3. Fill in the details for the application, such as **Name**, **Supported account types**, and **Redirect URI** (`http://localhost:8000/`).\\n\\n    :::note\\n    The **Name** `kuberocketci` is used as a demonstration example. In your case, it is recommended to choose a name that aligns with your application\'s specific needs and naming conventions (e.g. your AWS EKS cluster name).\\n    :::\\n\\n    ![Application Details](../assets/aws-eks-microsoft-entra-oidc-integration/application-details.png)\\n\\n4. In the created application, navigate to the **Authentication** section from the left sidebar menu. In the **Implicit grant and hybrid flows** section, select **ID tokens** for the token type. In the **Allow public client flows** section, set the value to **No**.\\n\\n    ![Authentication Settings](../assets/aws-eks-microsoft-entra-oidc-integration/authentication-settings.png)\\n\\n5. Navigate to the **Certificates & secrets** section from the left sidebar menu. In the **Client secrets** tab, click on the **New client secret** button to create a new secret.\\n\\n    ![Client Secret](../assets/aws-eks-microsoft-entra-oidc-integration/client-secret.png)\\n\\n6. Copy the generated client secret value and store it securely.\\n\\n    ![Client Secret Value](../assets/aws-eks-microsoft-entra-oidc-integration/client-secret-value.png)\\n\\n7. Navigate to the **Token configuration** section and click on **Add group claim** button. Choose the group type as **Security Groups** and for the ID token type, select **Group ID**.\\n\\n    ![Token Configuration](../assets/aws-eks-microsoft-entra-oidc-integration/token-configuration.png)\\n\\n8. (Optional) Additionally, add an optional **upn** claim in the **Token configuration** section.\\n\\n    :::note\\n    This step is optional and should only be performed if external users (i.e., users with **User type: Guest**) will be added to the Microsoft Entra Tenant and require access to the Application.\\n    :::\\n\\n    ![upn Claim](../assets/aws-eks-microsoft-entra-oidc-integration/upn-claim.png)\\n\\n9. (Optional) After adding the **upn** claim, click on the three dots next to it, select **Edit**, and turn on the **Externally authenticated** toggle to **Yes** value.\\n\\n    :::note\\n    This step is optional and should only be performed if external users (i.e., users with **User type: Guest**) will be added to the Microsoft Entra Tenant and require access to the Application.\\n    :::\\n\\n    ![Externally Authenticated](../assets/aws-eks-microsoft-entra-oidc-integration/externally-authenticated.png)\\n\\n10. Navigate to the **API permissions** section. Ensure that the **User.Read** permission is added under the **Microsoft Graph** API. If not, click on the **Add a permission** button, select **Microsoft Graph**, and add the **User.Read** permission. After adding the permission, click on the **Grant admin consent for \'Tenant name\'** button to grant the required permissions.\\n\\n     ![API Permissions](../assets/aws-eks-microsoft-entra-oidc-integration/api-permissions.png)\\n\\n11. (Optional) Additionally, for **Microsoft Graph** API, add the **OpenId** permissions, such as **openid**, **email**, and **profile**.\\n\\n    :::note\\n    This step is optional and should only be performed if external users (i.e., users with **User type: Guest**) will be added to the Microsoft Entra Tenant and require access to the Application.\\n    :::\\n\\n    ![OpenID Permissions](../assets/aws-eks-microsoft-entra-oidc-integration/openid-permissions.png)\\n\\n12. The OIDC Application in Microsoft Entra is now configured and ready for integration with AWS EKS.\\n\\n## Creating Users and Groups in Microsoft Entra\\n\\n:::note\\nOnly users who are part of the groups configured in the Microsoft Entra Admin Center will be able to authenticate to the AWS EKS cluster using OIDC.\\n:::\\n\\nTo create users and groups in Microsoft Entra, follow these steps:\\n\\n### Creating a Group\\n\\n1. In the Microsoft Entra Admin Center, in the left sidebar menu, select **Groups** and then **All groups**. Click on **New group** button to create a new group(s) for users who will have access to the AWS EKS cluster.\\n\\n    ![New Group](../assets/aws-eks-microsoft-entra-oidc-integration/new-group.png)\\n\\n2. Fill in the details for the group, such as **Group type** and **Group name**. Click on the **Create** button to create the group.\\n\\n    ![Group Details](../assets/aws-eks-microsoft-entra-oidc-integration/group-details.png)\\n\\n3. The group will be created, and you can start adding users to it.\\n\\n### Adding Users to the Group\\n\\n1. In the Microsoft Entra Admin Center, in the left sidebar menu, select **Users** and then click on **All users**. In the **New user** tab, click on the **Create new user** button to create a new user.\\n\\n    ![New User](../assets/aws-eks-microsoft-entra-oidc-integration/new-user.png)\\n\\n2. Fill in the details for the user, such as **User principal name**, **Mail nickname**, **Display name**, and temporary password. In the **Properties** tab you can set the **First name**, **Last name**, and other details.\\n\\n    ![User Details](../assets/aws-eks-microsoft-entra-oidc-integration/user-details.png)\\n\\n3. In the **Assignment** tab, click on the **Add group** button. In the **Select Group** window, choose the group(s) you created earlier (e.g., `oidc-cluster-admins`) and click on the **Select** button.\\n\\n    ![Add Group](../assets/aws-eks-microsoft-entra-oidc-integration/add-group.png)\\n\\n4. Click on the **Review + create** button to create the user. The user will be created and added to the group(s) you selected.\\n\\n## Configuring Microsoft Entra as an Identity Provider in AWS EKS\\n\\nThere are two methods to configure Microsoft Entra as an Identity Provider in AWS EKS: through the AWS Management Console and using Terraform.\\n\\n:::note\\nThe Application data, such as **Directory (tenant) ID**, **Application (client) ID**, and **Issuer URL**, can be found in the **Overview** section of the OIDC Application in the Microsoft Entra Admin Center.\\n![Application Data](../assets/aws-eks-microsoft-entra-oidc-integration/application-data.png)\\n:::\\n\\n### Method 1: Using the AWS Management Console\\n\\n1. Log in to the [AWS Management Console](https://aws.amazon.com/console/) and navigate to the [Amazon EKS console](https://console.aws.amazon.com/eks/). Select the EKS cluster you want to configure and click on the **Access** tab.\\n\\n    ![EKS Cluster Access Tab](../assets/aws-eks-microsoft-entra-oidc-integration/eks-cluster-access-tab.png)\\n\\n2. In the **OIDC identity providers** section, click on the **Associate identity provider** button.\\n\\n    ![Associate Identity Provider](../assets/aws-eks-microsoft-entra-oidc-integration/associate-identity-provider.png)\\n\\n3. Fill in the following details:\\n\\n    - **Name**: `Entra`\\n    - **Issuer URL**: `https://login.microsoftonline.com/<Tenant-ID>/`, where `<Tenant-ID>` is the **Directory** (tenant) **ID**. Ensure that the URL ends with `/`.\\n    - **Client ID**: `<Application (client) ID>`, which corresponds to the **Application** (client) **ID** of the OIDC Application.\\n    - **Username Claim**: `upn`.\\n    - **Groups Claim**: `groups`.\\n\\n      ![Identity Provider Details](../assets/aws-eks-microsoft-entra-oidc-integration/identity-provider-details.png)\\n\\n4. The process of applying the changes may take a few minutes. Once completed, the Microsoft Entra OIDC identity provider will be associated with the AWS EKS cluster.\\n\\n### Method 2: Using Terraform\\n\\nTo configure Microsoft Entra as an Identity Provider in AWS EKS using Terraform, you can use [AWS EKS Terraform module](https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/20.30.1). Here\'s an example of how you can do it:\\n\\n    - **variables.tf**:\\n\\n    ```hcl\\n    variable \\"cluster_identity_providers\\" {\\n      description = \\"Configuration for OIDC identity provider\\"\\n      type        = any\\n      default     = {}\\n    }\\n    ```\\n\\n    - **terraform.tfvars**:\\n\\n    ```hcl\\n    cluster_identity_providers = {\\n      entra = {\\n        client_id    = \\"<Application (client) ID>\\"\\n        issuer_url   = \\"https://sts.windows.net/<Tenant ID>/\\"\\n        groups_claim = \\"groups\\"\\n        username_claim  = \\"upn\\"\\n      }\\n    }\\n    ```\\n\\n    - **main.tf**:\\n\\n    ```hcl\\n    module \\"eks\\" {\\n      source  = \\"terraform-aws-modules/eks/aws\\"\\n      version = \\"20.14.0\\"\\n      ...\\n      # OIDC Identity provider\\n      cluster_identity_providers = var.cluster_identity_providers\\n    }\\n    ```\\n\\nAfter applying the Terraform configuration, the Microsoft Entra OIDC identity provider will be associated with the AWS EKS cluster.\\n\\n## Configuring RBAC Resources in AWS EKS cluster for Microsoft Entra User Groups\\n\\nIn this section, user authorization will be configured using Kubernetes Role-Based Access Control (RBAC). Microsoft Entra groups will be linked to Kubernetes ClusterRoles through ClusterRoleBinding resources, enabling precise control over resource access within the EKS cluster. Additionally, Roles and RoleBindings can be used for more granular access control within specific namespaces.\\n\\n:::note\\nThe **Object ID** of the Microsoft Entra group can be found in the **Overview** section of the group in the Microsoft Entra Admin Center.\\n![Group Object ID](../assets/aws-eks-microsoft-entra-oidc-integration/group-object-id.png)\\n:::\\n\\n1. Log in to the AWS EKS cluster and create the following **ClusterRoleBinding** resource, which associates the Microsoft Entra group `oidc-cluster-admins` with the `cluster-admin` Kubernetes Cluster Role. Replace `<your-microsoft-entra-admin-group-object-id>` with the Object ID of the `oidc-cluster-admins` group, which can be found on the `Group` overview page in the Microsoft Entra admin center.\\n\\n    ```yaml\\n    apiVersion: rbac.authorization.k8s.io/v1\\n    kind: ClusterRoleBinding\\n    metadata:\\n      name: oidc-cluster-admins\\n    roleRef:\\n      apiGroup: rbac.authorization.k8s.io\\n      kind: ClusterRole\\n      name: cluster-admin\\n    subjects:\\n      - kind: Group\\n        name: <your-microsoft-entra-admin-group-object-id>\\n        apiGroup: rbac.authorization.k8s.io\\n    ```\\n\\n    Save the above YAML to a file, for example, `clusterrolebinding.yaml`, and apply it to the EKS cluster using the following command:\\n\\n    ```bash\\n    kubectl apply -f clusterrolebinding.yaml\\n    ```\\n\\n    The `oidc-cluster-admins` group will now have `cluster-admin` permissions within the EKS cluster.\\n\\n## Authenticating to AWS EKS using Microsoft Entra with kubectl\\n\\nTo authenticate to the AWS EKS cluster using Microsoft Entra, you can use the `kubectl` CLI tool with the `kubelogin` plugin. The `kubelogin` plugin simplifies the OIDC authentication process by handling the token exchange and session management. Here\'s how you can authenticate to the EKS cluster:\\n\\n1. Create or update the kubeconfig file with the OIDC configuration. Replace `<cluster-name>` with the name of your EKS cluster and `<region-code>` with the AWS region code where the cluster is located.\\n\\n    ```bash\\n    aws eks update-kubeconfig --region <region-code> --name <cluster-name>\\n    ```\\n\\n2. Execute the following command to create a new kubeconfig context using the `kubelogin` plugin. Replace `<cluster-name>` with the name of your EKS cluster.\\n\\n    ```bash\\n    kubectl config set-credentials \\"eks\\" \\\\\\n      --exec-api-version=client.authentication.k8s.io/v1beta1 \\\\\\n      --exec-command=kubelogin \\\\\\n      --exec-arg=get-token \\\\\\n      --exec-arg=--oidc-issuer-url \\\\\\n      --exec-arg=https://sts.windows.net/<Tenant ID>/ \\\\\\n      --exec-arg=--oidc-client-id \\\\\\n      --exec-arg=<Application (client) ID> \\\\\\n      --exec-arg=--oidc-client-secret \\\\\\n      --exec-arg=<Application (client) Secret>\\n    ```\\n\\n    Replace `<Tenant ID>`, `<Application (client) ID>`, and `<Application (client) Secret>` with the corresponding values from the OIDC Application in the Microsoft Entra Admin Center.\\n\\n    :::note\\n    You can test the authentication to the EKS cluster immediately by running the following command:\\n\\n    ```bash\\n    kubectl --user=eks get nodes\\n    ```\\n\\n    :::\\n\\n3. Set the context for the kubeconfig file to use the `eks` user and the OIDC configuration. Replace `<cluster-name>` with the name of your EKS cluster.\\n\\n    ```bash\\n    kubectl config set-context eks --user=eks --cluster=<cluster-name>\\n    ```\\n\\n    To switch to the `eks` context, execute the following command:\\n\\n    ```bash\\n    kubectl config use-context eks\\n    ```\\n\\n    Test the authentication by running the following command:\\n\\n    ```bash\\n    kubectl get nodes\\n    ```\\n\\n## Configuring KubeRocketCI Portal with Microsoft Entra OIDC Authentication\\n\\n1. Starting from version 3.10, KubeRocketCI platform supports Microsoft Entra as an Identity Provider for OIDC authentication in the Portal UI. To configure Microsoft Entra OIDC authentication, navigate to the [edp-install](https://github.com/epam/edp-install) Helm chart repository and set the following values in the `values.yaml` file:\\n\\n    ```yaml\\n    ...\\n    edp-headlamp:\\n      enabled: true\\n      config:\\n        oidc:\\n          enabled: true\\n          issuerUrl: \\"https://sts.windows.net/<Tenant ID>/\\"\\n          clientID: \\"<Application (client) ID>\\"\\n          clientSecretName: \\"<name of the secret containing the client-secret value>\\"\\n          clientSecretKey: \\"clientSecret\\"\\n    ...\\n    ```\\n\\n    Replace `<Tenant ID>` and `<Application (client) ID>` with the corresponding values from the OIDC Application in the Microsoft Entra Admin Center. Also, specify the name of the Kubernetes Secret containing the Application **Client secret** value in the `clientSecretName` field.\\n\\n2. In the Microsoft Entra Admin Center, navigate to the created OIDC Application and select the **Authentication** section. In the **Redirect URIs** field, add the URL of the KubeRocketCI Portal, for example, `https://portal-<krci-namespace>.<dns-wildcard>/oidc-callback`.\\n\\n    ![Redirect URIs](../assets/aws-eks-microsoft-entra-oidc-integration/redirect-uris.png)\\n\\n3. After applying the changes, the KubeRocketCI Portal will be configured to use Microsoft Entra OIDC authentication. Users will be able to log in to the Portal using **Sign In** option.\\n\\n    ![Sign In](../assets/aws-eks-microsoft-entra-oidc-integration/sign-in.png)\\n\\n## Conclusion\\n\\nIntegrating OpenID Connect (OIDC) authentication with Microsoft Entra in AWS EKS is a powerful way to enhance security and streamline user access management. By leveraging the capabilities of SSO, OIDC, and Microsoft Entra, organizations can simplify authentication processes, enforce access controls, and ensure secure navigation across cloud-native environments. Whether you\'re managing user identities, enhancing compliance, or improving user experience, this integration provides a robust solution to meet your identity and access management needs. By following the steps outlined in this guide, you can configure Microsoft Entra as an Identity Provider in AWS EKS, authenticate users using OIDC, and secure access to your EKS clusters and KubeRocketCI Portal effectively."},{"id":"advanced-aws-eks-management-oidc-keycloak","metadata":{"permalink":"/blog/advanced-aws-eks-management-oidc-keycloak","source":"@site/blog/2024-10-04/aws-eks-oidc-kuberocketci.md","title":"Advanced AWS EKS Management: Implementing SSO via OIDC and Keycloak","description":"Learn how to implement Single Sign-On (SSO) using OpenID Connect (OIDC) and Keycloak to boost security and streamline authentication processes in Amazon Elastic Kubernetes Service (AWS EKS).","date":"2024-10-04T00:00:00.000Z","tags":[{"inline":true,"label":"KubeRocketCI","permalink":"/blog/tags/kube-rocket-ci"},{"inline":true,"label":"Keycloak","permalink":"/blog/tags/keycloak"},{"inline":true,"label":"AWS EKS","permalink":"/blog/tags/aws-eks"},{"inline":true,"label":"SSO","permalink":"/blog/tags/sso"}],"readingTime":10.845,"hasTruncateMarker":true,"authors":[{"name":"Sergiy Kulanov","title":"Systems Architect and DevOps Advocate, Open Source Enthusiast and Contributor","url":"https://github.com/sergk","page":{"permalink":"/blog/authors/sergk"},"socials":{"x":"https://x.com/sergiy_kulanov","github":"https://github.com/sergk","linkedin":"https://www.linkedin.com/in/skulanov/"},"imageURL":"https://docs.kuberocketci.io/img/profile_sergk.png","key":"sergk"},{"name":"Mykola Marusenko","title":"Co-creator of KubeRocketCI","url":"https://github.com/mykolamarusenko","page":{"permalink":"/blog/authors/mykolamarusenko"},"socials":{"linkedin":"https://www.linkedin.com/in/mykola-marusenko/","github":"https://github.com/mykolamarusenko"},"imageURL":"https://docs.kuberocketci.io/img/profile_mykolamarusenko.png","key":"mykolamarusenko"},{"name":"Daniil Nedostup","title":"Systems Engineer","url":"https://github.com/daniil-nedostup","page":{"permalink":"/blog/authors/daniilnedostup"},"socials":{"linkedin":"https://www.linkedin.com/in/daniil-nedostup/","github":"https://github.com/daniil-nedostup"},"imageURL":"https://github.com/daniil-nedostup.png","key":"daniilnedostup"}],"frontMatter":{"title":"Advanced AWS EKS Management: Implementing SSO via OIDC and Keycloak","description":"Learn how to implement Single Sign-On (SSO) using OpenID Connect (OIDC) and Keycloak to boost security and streamline authentication processes in Amazon Elastic Kubernetes Service (AWS EKS).","slug":"advanced-aws-eks-management-oidc-keycloak","tags":["KubeRocketCI","Keycloak","AWS EKS","SSO"],"keywords":["Keycloak","AWS EKS","Kubernetes","AWS","EKS","IAM","OpenID Connect","Single Sign-On","Security","Authentication","Authorization"],"image":"https://i.imgur.com/mErPwqL.png","authors":["sergk","mykolamarusenko","daniilnedostup"],"hide_table_of_contents":false},"unlisted":false,"prevItem":{"title":"Integrating OIDC Authentication with Microsoft Entra in AWS EKS","permalink":"/blog/integrating-oidc-authentication-microsoft-entra-aws-eks"}},"content":"In today\'s cloud-first world, ensuring seamless and secure access to Amazon Elastic Kubernetes Service (EKS) is essential for IT teams. Our guide helps you enhance EKS security by integrating Single Sign-On (SSO) with OpenID Connect (OIDC) and Keycloak. This integration simplifies authentication and strengthens security measures. We aim to provide you with effective strategies to implement a robust SSO solution that meets your organization\'s standards, making your EKS environment more secure and compliant. KubeRocketCI leverages this integration to provide Role-Based Access Control (RBAC) for your EKS clusters, ensuring that only authorized users can access platform resources.\\n\\n\x3c!--truncate--\x3e\\n\\n## Prerequisites\\n\\nBefore you begin, ensure you have the following:\\n\\n- A running [AWS EKS](https://docs.aws.amazon.com/eks/latest/userguide/create-cluster.html) cluster with the necessary permissions for access and management.\\n- Forked and cloned the [edp-cluster-add-ons](https://github.com/epam/edp-cluster-add-ons) repository.\\n- The [kubelogin](https://github.com/int128/kubelogin) plugin installed for authenticating to the EKS cluster using OIDC.\\n- The [kubectl](https://kubernetes.io/docs/tasks/tools/#kubectl) cli tool installed.\\n- The [aws cli](https://aws.amazon.com/cli/) tool installed.\\n- [Keycloak](../../docs/operator-guide/auth/keycloak) installed and configured with the [kuberocketci-rbac](https://github.com/epam/edp-cluster-add-ons/tree/main/clusters/core/addons/kuberocketci-rbac) Helm chart, which can be found in the [add-ons repository](https://github.com/epam/edp-cluster-add-ons).\\n- The [Keycloak-operator](https://github.com/epam/edp-keycloak-operator) installed.\\n\\n## Understanding SSO, OIDC, and Keycloak\\n\\nIn the context of enhancing digital security and user experience, we prioritize the integration of three key elements: Single Sign-On (SSO), OpenID Connect (OIDC), and the Keycloak solution. Here\u2019s how they connect:\\n\\n- **Single Sign-On (SSO)** serves as the foundation, enabling users to access multiple applications with one set of login credentials, significantly simplifying the authentication process.\\n\\n- **OpenID Connect (OIDC)** builds on the SSO framework by providing an authentication layer, which uses straightforward identity verification to ensure secure and seamless access across services.\\n\\n- **Keycloak** acts as the orchestrator, implementing both SSO and OIDC to manage user identities and security protocols efficiently. It provides a comprehensive platform for securing applications and services with minimal hassle for end-users.\\n\\nTogether, these technologies streamline the login process, reinforce security, and enhance the user experience by allowing secure, seamless navigation across our digital ecosystem.\\n\\n### What is SSO?\\n\\nSingle sign-on (SSO) is a user authentication method that lets you use one set of login credentials (such as a username and password) to access multiple applications. The primary benefits of SSO include an improved user experience by eliminating the need for multiple passwords and logins, and enhanced security through centralized management of user access. Organizations widely adopt SSO to streamline their authentication processes and reduce the likelihood of password fatigue among users, thereby decreasing the risk of security breaches. For more information, see [Single sign-on on Wikipedia](https://en.wikipedia.org/wiki/Single_sign-on).\\n\\n```mermaid\\nsequenceDiagram\\n    participant U as User\\n    participant SSO as SSO Gateway\\n    participant A1 as Application 1\\n    participant A2 as Application 2\\n    participant A3 as Application 3\\n\\n    U->>SSO: Log in once\\n    SSO->>U: Authentication & Session creation\\n    Note over U, A3: User accesses applications without re-logging in\\n    U->>A1: Access request\\n    A1->>SSO: Verify user session\\n    SSO->>A1: Session valid\\n    A1->>U: Access granted\\n    U->>A2: Access request\\n    A2->>SSO: Verify user session\\n    SSO->>A2: Session valid\\n    A2->>U: Access granted\\n    U->>A3: Access request\\n    A3->>SSO: Verify user session\\n    SSO->>A3: Session valid\\n    A3->>U: Access granted\\n```\\n\\nThis diagram shows the following steps:\\n\\n1. User logs in once at the single sign-on (SSO) gateway by providing their credentials.\\n2. The SSO gateway authenticates the user, creates a session, and then allows the user to access multiple applications.\\n3. When the user attempts to access Application 1, the application verifies the user\'s session with the SSO gateway.\\n4. The SSO gateway confirms that the session is valid, and Application 1 grants the user access.\\n\\nThe same process is repeated for Application 2 and Application 3. Since the user\'s session is already established with the SSO gateway, they do not need to log in again to access these applications.\\n\\n### Understanding OIDC\\n\\nOpenID Connect (OIDC) is an authentication layer on top of the OAuth 2.0 protocol. It lets clients verify the identity of the end user based on authentication by an authorization server and get basic profile information about the end user in an interoperable and REST-like manner. OIDC uses JSON Web Tokens (JWTs) to securely transmit information about an end user from the identity provider to the client. This protocol is essential for modern web applications, providing a more secure and streamlined method for user authentication and authorization. Reference: [OIDC Specification](https://openid.net/specs/openid-connect-core-1_0.html)\\n\\nOIDC enables single sign-on (SSO) functionality, simplifying the user experience by allowing individuals to use a single set of credentials across multiple applications. The protocol also supports robust security features, including token revocation and introspection, enhancing overall application security.\\n\\nThis diagram simplifies the OIDC flow into its core components:\\n\\n```mermaid\\nsequenceDiagram\\n    participant U as User\\n    participant C as Client Application\\n    participant AS as Authorization Server\\n    participant RS as Resource Server\\n\\n    U->>C: Requests access\\n    C->>AS: Redirects to Authorization Server for authentication\\n    AS->>U: Prompts user for authentication (login)\\n    U->>AS: Submits credentials\\n    AS->>C: Redirects with authorization code\\n    C->>AS: Exchanges authorization code for ID token & access token\\n    AS->>C: Returns ID token & access token\\n    C->>U: Grants access\\n    C->>RS: Accesses resources using access token\\n    RS->>C: Returns requested resources\\n```\\n\\n1. **User (U)**: The end user who wants to access the client application.\\n2. **Client Application (C)**: The application requiring authentication from the user.\\n3. **Authorization Server (AS)**: The server that authenticates the user and issues tokens to the client application.\\n4. **Resource Server (RS)**: The server hosting protected resources that the client application wants to access on behalf of the user.\\n\\nThe sequence starts with the user requesting access to the client application, moving through authentication with the authorization server, and ending with the client application accessing protected resources.\\n\\n### Keycloak Overview\\n\\nKeycloak is an open-source identity and access management solution for modern applications and services. It offers features like single sign-on (SSO), social login, and identity brokering, making it a comprehensive solution for managing user identities. Keycloak integrates seamlessly with LDAP (Lightweight Directory Access Protocol) and Active Directory and supports OpenID Connect (OIDC), OAuth 2.0, and Security Assertion Markup Language (SAML) 2.0. By using Keycloak, organizations can enhance their security and provide a better user experience without building complex identity management features from scratch. For more details, see the Keycloak [official documentation](https://www.keycloak.org/documentation.html).\\n\\n## Keycloak Configuration\\n\\nThe first step to enable OIDC authentication to the AWS EKS cluster using Keycloak is to set up Keycloak with the necessary configurations, such as realm, client, groups, and other settings. For this purpose, we will use the [kuberocketci-rbac](https://github.com/epam/edp-cluster-add-ons/tree/main/clusters/core/addons/kuberocketci-rbac) Helm chart available in the [edp-cluster-add-ons](https://github.com/epam/edp-cluster-add-ons) repository.\\n\\n1. Clone the forked [edp-cluster-add-ons](https://github.com/epam/edp-cluster-add-on) repository and navigate to the `clusters/core/addons/kuberocketci-rbac` directory.\\n\\n2. In the `values.yaml` file, set the `kubernetes.enabled` field to `true` to enable the creation of the necessary Keycloak resources:\\n\\n    ```yaml title=\\"values.yaml\\"\\n    kubernetes:\\n      enabled: true\\n    ```\\n\\n3. If you use the External Secrets Operator to manage secrets, ensure the AWS Parameter Store object contains the correct Client Secret value for the **keycloak-client-eks-secret** secret:\\n\\n    ```json title=\\"AWS Parameter Store object\\"\\n    {\\n      ...\\n      \\"keycloak-client-eks-secret\\": {\\n        \\"clientSecret\\": \\"<Client_Secret_Value>\\"\\n      },\\n      ...\\n    }\\n    ```\\n\\n    If you are not using the External Secrets Operator, you can create the **keycloak-client-eks-secret** secret manually:\\n\\n    ```bash\\n    kubectl create secret generic keycloak-client-eks-secret \\\\\\n      --from-literal=clientSecret=<Client_Secret_Value>\\n    ```\\n\\n4. Install the **kuberocketci-rbac** Helm chart. You can use the **kubectl** cli tool or **Argo CD** for this purpose.\\n\\n    - **kubectl**\\n\\n    Ensure you are in the `clusters/core/addons/kuberocketci-rbac` directory if you want to install the chart with the kubectl command. For example:\\n\\n    ```bash\\n    kubectl upgrade --install kuberocketci-rbac -n security .\\n    ```\\n\\n    - **Argo CD**\\n\\n    If you are using Argo CD to deploy charts in the **edp-cluster-add-ons** repository, ensure that the following fields for the **kuberocketci-rbac** Helm chart are correctly set in the `values.yaml` file in the `clusters/core/apps` directory:\\n\\n    ```yaml title=\\"values.yaml\\"\\n    kuberocketci-rbac:\\n      createNamespace: false\\n      enable: true\\n    ```\\n\\n    After the installation is complete, check that the Keycloak resources, such as the realm, client, and groups, have been created successfully.\\n\\n## Adding Users to Groups in Keycloak\\n\\nTo manage user access to the AWS EKS cluster, you need to assign users to specific groups in Keycloak. These groups will define the permissions for users accessing the AWS EKS cluster.\\n\\n1. Log in to the Keycloak admin console and navigate to the **shared** realm.\\n\\n2. Select the **Users** section from the left sidebar menu and select the user you want to add to a group. Navigate to the **Groups** tab and click on the **Join Group** button to add the user to a group.\\n\\n    ![Keycloak Add User to Group](../assets/aws-eks-oidc-keycloak/keycloak-add-user-to-group.png)\\n\\n3. Select the group you want to add the user to (e.g., **oidc-cluster-admins**). Click on the **Join** button to add the user to the selected group.\\n\\n    ![Keycloak Join Group](../assets/aws-eks-oidc-keycloak/keycloak-join-group.png)\\n\\n4. Repeat the process of adding users to groups for all users who need access to the AWS EKS cluster.\\n\\n## Configuring Keycloak as an Identity Provider in AWS EKS\\n\\nThere are two methods to configure Keycloak as an identity provider in AWS EKS: using the AWS Management Console or Terraform.\\n\\n### Method 1: Using the AWS Management Console\\n\\n1. Log in to the [AWS Management Console](https://aws.amazon.com/console/) and navigate to the Amazon EKS service. Select the EKS cluster you want to configure and click on the **Access** tab.\\n\\n    ![EKS Cluster Access Tab](../assets/aws-eks-microsoft-entra-oidc-integration/eks-cluster-access-tab.png)\\n\\n2. In the **OIDC identity providers** section, click on the **Associate identity provider** button.\\n\\n    ![Associate Identity Provider](../assets/aws-eks-microsoft-entra-oidc-integration/associate-identity-provider.png)\\n\\n3. Fill in the following details for the Keycloak Identity Provider:\\n\\n    - **Name**: `Keycloak`\\n    - **Issuer URL**: `https://<keycloak_url>/auth/realms/shared`, where `<keycloak_url>` is the URL of your Keycloak instance.\\n    - **Client ID**: `eks`.\\n    - **Groups Claim**: `groups`.\\n\\n      ![Identity Provider Details](../assets/aws-eks-microsoft-entra-oidc-integration/identity-provider-details.png)\\n\\n4. The process of applying the changes may take a few minutes. Once completed, you will see the Keycloak Identity Provider associated with your EKS cluster.\\n\\n### Method 2: Using Terraform\\n\\nTo configure Keycloak as an Identity Provider in AWS EKS cluster using Terraform, you can use the [AWS EKS Terraform module](https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/20.30.1). Here\'s an example of how to define the Keycloak Identity Provider in Terraform configuration files:\\n\\n    - **variables.tf**:\\n\\n    ```hcl\\n    variable \\"cluster_identity_providers\\" {\\n      description = \\"Configuration for OIDC identity provider\\"\\n      type        = any\\n      default     = {}\\n    }\\n    ```\\n\\n    - **terraform.tfvars**:\\n\\n    ```hcl\\n    cluster_identity_providers = {\\n      keycloak = {\\n        client_id    = \\"eks\\"\\n        issuer_url   = \\"https://<keycloak_url>/auth/realms/shared\\"\\n        groups_claim = \\"groups\\"\\n      }\\n    }\\n    ```\\n\\n    - **main.tf**:\\n\\n    ```hcl\\n    module \\"eks\\" {\\n      source  = \\"terraform-aws-modules/eks/aws\\"\\n      version = \\"20.14.0\\"\\n      ...\\n      # OIDC Identity provider\\n      cluster_identity_providers = var.cluster_identity_providers\\n    }\\n    ```\\n\\nAfter applying the Terraform configuration, the Keycloak identity provider will be associated with your EKS cluster.\\n\\n## Authenticating to AWS EKS cluster using kubectl\\n\\n1. Configure **kubeconfig** file to use the Keycloak Identity Provider for authentication to the AWS EKS cluster. You can use the following template:\\n\\n    ```yaml title=\\"kubeconfig\\"\\n    apiVersion: v1\\n    preferences: {}\\n    kind: Config\\n\\n    clusters:\\n    - cluster:\\n        server: https://<eks_cluster_endpoint>.eks.amazonaws.com\\n        certificate-authority-data: <eks_cluster_ca>\\n      name: eks\\n\\n    contexts:\\n    - context:\\n        cluster: eks\\n        user: <keycloak_user_email>\\n      name: eks\\n\\n    current-context: eks\\n\\n    users:\\n    - name: <keycloak_user_email>\\n      user:\\n        exec:\\n          apiVersion: client.authentication.k8s.io/v1beta1\\n          command: kubectl\\n          args:\\n          - oidc-login\\n          - get-token\\n          - -v1\\n          - --oidc-issuer-url=https://<keycloak_url>/auth/realms/shared\\n          - --oidc-client-id=eks\\n          - --oidc-client-secret=<keycloak_client_secret>\\n    ```\\n\\n    Replace the placeholders with the actual values:\\n\\n    - `<eks_cluster_endpoint>`: The endpoint of your AWS EKS cluster.\\n    - `<eks_cluster_ca>`: The CA certificate of your AWS EKS cluster.\\n    - `<keycloak_user_email>`: The email address of the Keycloak user.\\n    - `<keycloak_url>`: The URL of your Keycloak instance.\\n    - `<keycloak_client_secret>`: The Client secret of the **eks** Keycloak client (provided during the **Keycloak Configuration** step).\\n\\n2. Save the kubeconfig file and set the `KUBECONFIG` environment variable to point to the file:\\n\\n    ```bash\\n    export KUBECONFIG=<path_to_kubeconfig_file>\\n    ```\\n\\n3. Test the authentication to the AWS EKS cluster by running the following command:\\n\\n    ```bash\\n    kubectl get nodes\\n    ```\\n\\n    After the first command execution, you will be prompted to log in to Keycloak. Enter your credentials to authenticate and access the EKS cluster. If the authentication is successful, you will see the list of nodes in the EKS cluster.\\n\\n## Configuring KubeRocketCI Portal with Keycloak OIDC Authentication\\n\\nThe KubeRocketCI platform natively supports Keycloak as an Identity Provider for OIDC authentication.\\n\\n1. To configure the KubeRocketCI Portal with Keycloak OIDC authentication, navigate to the [edp-install](https://github.com/epam/edp-install) Helm chart and set the following values in the `values.yaml` file:\\n\\n    ```yaml title=\\"values.yaml\\"\\n    edp-headlamp:\\n      enabled: true\\n      config:\\n        oidc:\\n          enabled: true\\n          issuerUrl: \\"https://<keycloak_url>/auth/realms/shared\\"\\n          clientID: \\"eks\\"\\n          clientSecretName: \\"keycloak-client-headlamp-secret\\"\\n          clientSecretKey: \\"clientSecret\\"\\n    ```\\n\\n    Replace the **keycloak_url** with the URL of your Keycloak instance.\\n\\n2. Ensure the AWS Parameter Store object contains the correct Client Secret value for the **keycloak-client-headlamp-secret** secret:\\n\\n    ```json title=\\"AWS Parameter Store object\\"\\n    {\\n      ...\\n      \\"keycloak-client-headlamp-secret\\": \\"<Client_Secret_Value>\\"\\n      ...\\n    }\\n    ```\\n\\n3. After setting the values, install the **edp-install** Helm chart to apply the changes:\\n\\n    ```bash\\n    helm upgrade --install krci --namespace krci .\\n    ```\\n\\n4. After applying the changes, the KubeRocketCI Portal will be configured to use Keycloak OIDC authentication. Users will be able to log in to the Portal using **Sign In** option.\\n\\n    ![Sign In](../assets/aws-eks-microsoft-entra-oidc-integration/sign-in.png)\\n\\n## Conclusion\\n\\nIntegrating OpenID Connect (OIDC) authentication with Keycloak in AWS EKS enhances security and simplifies user access management. By leveraging Keycloak\'s capabilities, you can implement a reliable Single Sign-On (SSO) solution that meets your organization\'s security standards. This guide has provided step-by-step instructions to configure Keycloak as an Identity Provider, set up necessary Keycloak resources, and enable OIDC authentication for the KubeRocketCI Portal. By following these steps, you can ensure secure and seamless access to your EKS clusters and KubeRocketCI Portal, improving both security and user experience."}]}}')}}]);